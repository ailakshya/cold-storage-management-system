# Caddyfile for direct uploads (bypassing Cloudflare proxy completely)
#
# Uses Let's Encrypt with Cloudflare DNS challenge for HTTPS
# This allows DNS-only mode (no Cloudflare proxy) for true direct connection
#
# Prerequisites:
# 1. CF_API_TOKEN in .env.production with Zone:DNS:Edit permission
# 2. DNS A record: direct.gurukripacoldstore.in → server IP (DNS only, grey cloud)
# 3. Router port forward: external 443 → server:443

direct.gurukripacoldstore.in {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }

    # CORS for cross-origin uploads from the main domain
    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "https://app.gurukripacoldstore.in"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Authorization, Content-Type"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }

    # Add CORS headers to all responses
    header Access-Control-Allow-Origin "https://app.gurukripacoldstore.in"
    header Access-Control-Allow-Credentials "true"

    # Proxy to backend container
    reverse_proxy cold-backend:8080
}
