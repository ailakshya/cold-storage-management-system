# Caddyfile for direct API data transfer (bypassing Cloudflare proxy)
#
# Uses Let's Encrypt with Cloudflare DNS challenge for HTTPS
# Only proxies /api/* and /health — all other paths return 404
#
# Prerequisites:
# 1. CF_API_TOKEN in .env.production with Zone:DNS:Edit permission
# 2. DNS A record: direct.gurukripacoldstore.in → server IP (DNS only, grey cloud)
# 3. Router port forward: external 443 → server:443

direct.gurukripacoldstore.in {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }

    # Rate limiting: 100 requests/sec per IP (DDoS mitigation)
    rate_limit {
        zone direct_api {
            key    {remote_host}
            events 100
            window 1s
        }
    }

    # Only allow /api/* and /health paths
    @api_paths path /api/* /health

    handle @api_paths {
        # Dynamic CORS: allow both employee and customer portals
        @cors_origin header_regexp origin Origin ^https://(app|customer)\.gurukripacoldstore\.in$

        @cors_preflight {
            method OPTIONS
            header_regexp origin2 Origin ^https://(app|customer)\.gurukripacoldstore\.in$
        }

        handle @cors_preflight {
            header Access-Control-Allow-Origin "{http.request.header.Origin}"
            header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            header Access-Control-Allow-Headers "Authorization, Content-Type"
            header Access-Control-Max-Age "86400"
            respond "" 204
        }

        header @cors_origin Access-Control-Allow-Origin "{http.request.header.Origin}"
        header @cors_origin Access-Control-Allow-Credentials "true"

        reverse_proxy cold-backend:8080
    }

    # Block everything else — no pages, no login forms, no static files
    handle {
        respond "Not Found" 404
    }
}
