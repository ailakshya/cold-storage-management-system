<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рдзрди рдкреНрд░рд╛рдкреНрддрд┐ рд░рд╕реАрдж - Payment Receipt</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }

        @media print {
            .no-print {
                display: none;
            }
            @page {
                size: A5;
                margin: 10mm;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        .receipt-border {
            border: 3px solid #000;
            box-shadow: 5px 5px 0 #000;
        }

        .dotted-line {
            border-bottom: 2px dotted #000;
            display: inline-block;
            min-width: 200px;
        }

        .amount-box {
            border: 3px solid #000;
            padding: 10px 20px;
            display: inline-block;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .verification-code {
            font-family: monospace;
            word-break: break-all;
            background: #f5f5f5;
            padding: 8px;
            border: 2px dashed #666;
            font-size: 0.7rem;
        }
    </style>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/nav-utils.js"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-2xl mx-auto bg-white receipt-border p-6">
        <!-- Print Button -->
        <div class="no-print mb-4 flex justify-between">
            <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 font-bold border-2 border-black shadow-[4px_4px_0_0_#000] hover:shadow-none transition-all">
                ЁЯЦия╕П рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ
            </button>
            <div class="flex gap-2">
                <button onclick="goHome()" class="bg-emerald-500 text-white px-4 py-2 font-bold border-2 border-black shadow-[4px_4px_0_0_#000] hover:shadow-none transition-all">
                    ЁЯПа рд╣реЛрдо
                </button>
                <button onclick="history.back()" class="bg-gray-500 text-white px-4 py-2 font-bold border-2 border-black shadow-[4px_4px_0_0_#000] hover:shadow-none transition-all">
                    тЖР рд╡рд╛рдкрд╕
                </button>
            </div>
        </div>

        <!-- Header -->
        <div class="text-center mb-4 pb-3 border-b-2 border-black">
            <p class="text-sm font-semibold text-gray-600 mb-1">рдзрди рдкреНрд░рд╛рдкреНрддрд┐ рд░рд╕реАрдж</p>
            <h1 class="text-2xl font-black mb-1">рдЧреБрд░реБ рдХреГрдкрд╛ рдХреЛрд▓реНрдб рд╕реНрдЯреЛрд░</h1>
            <p class="text-xs text-gray-700">рдЧреНрд░рд╛рдо-рдХрд░реИрдерд╛, рдмрд┐рдЬрд▓реАрдШрд░ рдХреЗ рд╕рд╛рдордиреЗ, рдЬрд╣рд╛рдВрдЧреАрд░рд╛рдмрд╛рдж-рдФрд░рдВрдЧрд╛рдмрд╛рдж рд░реЛрдб, рдЬрд╣рд╛рдВрдЧреАрд░рд╛рдмрд╛рдж (рдмреБрд▓рдиреНрджрд╢рд╣рд░)</p>
        </div>

        <!-- Receipt Number and Date -->
        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-300">
            <div>
                <span class="font-semibold">рд░.рдХреНрд░реж </span>
                <span id="receiptNumber" class="font-black text-lg">-</span>
            </div>
            <div>
                <span class="font-semibold">рджрд┐рдирд╛рдВрдХ: </span>
                <span id="paymentDate" class="font-bold">-</span>
            </div>
        </div>

        <!-- Customer Details -->
        <div class="mb-4 space-y-3">
            <div class="flex flex-wrap items-baseline gap-1">
                <span class="font-semibold">рд╢реНрд░реАрдорд╛рди/рд╢реНрд░реАрдорддреА:</span>
                <span id="customerName" class="font-black text-lg dotted-line px-2">-</span>
                <span class="font-semibold ml-2">рдкрд┐рддрд╛:</span>
                <span id="customerSO" class="font-bold dotted-line px-2">-</span>
            </div>
            <div class="flex flex-wrap items-baseline gap-1">
                <span class="font-semibold">рдЧрд╛рдБрд╡:</span>
                <span id="customerVillage" class="font-bold dotted-line px-2">-</span>
                <span class="font-semibold ml-2">рдореЛ:</span>
                <span id="customerPhone" class="font-bold">-</span>
            </div>
            <div id="familyMemberRow" class="flex items-baseline gap-1" style="display: none;">
                <span class="font-semibold">рдкрд░рд┐рд╡рд╛рд░ рдХрд╛ рд╕рджрд╕реНрдп:</span>
                <span id="familyMemberName" class="font-bold text-blue-700 dotted-line px-2">-</span>
            </div>
        </div>

        <!-- Amount in Words -->
        <div class="mb-4 py-3 border-y-2 border-black">
            <div class="flex items-baseline gap-1 mb-2">
                <span class="font-semibold">рд░реБрдкрдпрд╛ (рд╢рдмреНрджреЛрдВ рдореЗрдВ):</span>
                <span id="amountInWords" class="font-bold text-lg dotted-line px-2 flex-1">-</span>
            </div>
            <div class="flex items-baseline gap-1">
                <span class="font-semibold">рджреНрд╡рд╛рд░рд╛:</span>
                <span id="paymentMethod" class="font-bold px-2">рдирдХрдж</span>
                <span class="ml-auto font-semibold text-green-700">рдкреНрд░рд╛рдкреНрдд рд╣реБрдПред</span>
            </div>
        </div>

        <!-- Amount Box and Balance -->
        <div class="flex justify-between items-center mb-4">
            <div class="amount-box bg-green-50">
                <span class="text-sm">рд░реБреж </span>
                <span id="amountPaid" class="text-green-700">-</span>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-600">рдХреБрд▓ рдХрд┐рд░рд╛рдпрд╛: <span id="totalRent" class="font-bold">тВ╣-</span></div>
                <div class="text-lg font-black">
                    рд╢реЗрд╖ рдмрдХрд╛рдпрд╛: <span id="balance" class="text-red-600">тВ╣-</span>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="mb-4" id="notesSection" style="display: none;">
            <span class="font-semibold text-sm">рдЯрд┐рдкреНрдкрдгреА:</span>
            <span id="notes" class="text-sm border-b border-dotted border-gray-500 px-2">-</span>
        </div>

        <!-- Processed By and Signature -->
        <div class="flex justify-between items-end mb-4 pt-3 border-t border-gray-300">
            <div>
                <p class="text-xs text-gray-600">рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛:</p>
                <p id="processedBy" class="font-bold text-sm">-</p>
            </div>
            <div class="text-center">
                <div class="border-t-2 border-black w-32 pt-1">
                    <p class="text-xs">рдкреНрд░рдмрдВрдзрдХ/рдПрдХрд╛рдЙрдиреНрдЯреЗрдВрдЯ</p>
                </div>
            </div>
        </div>

        <!-- Verification Code -->
        <div class="border-t-2 border-gray-300 pt-3 mt-4">
            <p class="text-xs text-gray-500 mb-1">рд╕рддреНрдпрд╛рдкрди рдХреЛрдб / Verification Code:</p>
            <div class="verification-code" id="verificationCode">
                Generating...
            </div>
            <p class="text-xs text-gray-400 mt-1 italic">
                рдпрд╣ рдХреЛрдб рдЗрд╕ рд░рд╕реАрдж рдХреА рдкреНрд░рд╛рдорд╛рдгрд┐рдХрддрд╛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред
            </p>
        </div>
    </div>

    <script>
        // Number to Hindi words conversion
        function numberToHindiWords(num) {
            const ones = ['', 'рдПрдХ', 'рджреЛ', 'рддреАрди', 'рдЪрд╛рд░', 'рдкрд╛рдБрдЪ', 'рдЫрдГ', 'рд╕рд╛рдд', 'рдЖрда', 'рдиреМ', 'рджрд╕',
                'рдЧреНрдпрд╛рд░рд╣', 'рдмрд╛рд░рд╣', 'рддреЗрд░рд╣', 'рдЪреМрджрд╣', 'рдкрдВрджреНрд░рд╣', 'рд╕реЛрд▓рд╣', 'рд╕рддреНрд░рд╣', 'рдЕрдард╛рд░рд╣', 'рдЙрдиреНрдиреАрд╕'];
            const tens = ['', '', 'рдмреАрд╕', 'рддреАрд╕', 'рдЪрд╛рд▓реАрд╕', 'рдкрдЪрд╛рд╕', 'рд╕рд╛рда', 'рд╕рддреНрддрд░', 'рдЕрд╕реНрд╕реА', 'рдирдмреНрдмреЗ'];

            if (num === 0) return 'рд╢реВрдиреНрдп';
            if (num < 0) return 'рдЛрдг ' + numberToHindiWords(-num);

            let words = '';

            if (Math.floor(num / 10000000) > 0) {
                words += numberToHindiWords(Math.floor(num / 10000000)) + ' рдХрд░реЛрдбрд╝ ';
                num %= 10000000;
            }

            if (Math.floor(num / 100000) > 0) {
                words += numberToHindiWords(Math.floor(num / 100000)) + ' рд▓рд╛рдЦ ';
                num %= 100000;
            }

            if (Math.floor(num / 1000) > 0) {
                words += numberToHindiWords(Math.floor(num / 1000)) + ' рд╣рдЬрд╝рд╛рд░ ';
                num %= 1000;
            }

            if (Math.floor(num / 100) > 0) {
                words += numberToHindiWords(Math.floor(num / 100)) + ' рд╕реМ ';
                num %= 100;
            }

            if (num > 0) {
                if (num < 20) {
                    words += ones[num];
                } else {
                    const ten = Math.floor(num / 10);
                    const one = num % 10;
                    if (one === 0) {
                        words += tens[ten];
                    } else if (one === 9 && ten < 9) {
                        words += 'рдЙрди' + tens[ten + 1].substring(0, tens[ten + 1].length - 1);
                    } else {
                        words += tens[ten] + (tens[ten] ? '' : '') + ones[one];
                    }
                }
            }

            return words.trim();
        }

        function amountToHindiWords(amount) {
            const rupees = Math.floor(amount);
            const paise = Math.round((amount - rupees) * 100);

            let result = numberToHindiWords(rupees) + ' рд░реБрдкрдпреЗ';
            if (paise > 0) {
                result += ' ' + numberToHindiWords(paise) + ' рдкреИрд╕реЗ';
            }
            result += ' рдорд╛рддреНрд░';
            return result;
        }

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const receiptNumber = urlParams.get('receipt');

        if (!receiptNumber) {
            alert('No receipt number provided');
            window.close();
        }

        // Fetch receipt data
        async function loadReceipt() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Not authenticated');
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch(`/api/rent-payments/receipt/${receiptNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load receipt');
                }

                const payment = await response.json();

                // Fetch customer details for S/O and village
                let customerSO = '';
                let customerVillage = '';
                try {
                    const custResponse = await fetch(`/api/customers/search?phone=${payment.customer_phone}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (custResponse.ok) {
                        const customers = await custResponse.json();
                        if (customers && customers.length > 0) {
                            customerSO = customers[0].so || '';
                            customerVillage = customers[0].village || '';
                        }
                    }
                } catch (e) {
                    console.error('Error fetching customer:', e);
                }

                displayReceipt(payment, customerSO, customerVillage);
            } catch (error) {
                console.error('Error loading receipt:', error);
                alert('Failed to load receipt: ' + error.message);
            }
        }

        async function displayReceipt(payment, customerSO, customerVillage) {
            document.getElementById('receiptNumber').textContent = payment.receipt_number;

            // Format date in Hindi style
            const date = new Date(payment.payment_date);
            const dateStr = date.toLocaleDateString('hi-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            document.getElementById('paymentDate').textContent = dateStr;

            document.getElementById('customerName').textContent = payment.customer_name;
            document.getElementById('customerSO').textContent = customerSO || '-';
            document.getElementById('customerVillage').textContent = customerVillage || '-';
            document.getElementById('customerPhone').textContent = payment.customer_phone;

            document.getElementById('amountPaid').textContent = payment.amount_paid.toFixed(2);
            document.getElementById('totalRent').textContent = 'тВ╣' + payment.total_rent.toFixed(2);
            document.getElementById('balance').textContent = 'тВ╣' + payment.balance.toFixed(2);

            // Amount in Hindi words
            document.getElementById('amountInWords').textContent = amountToHindiWords(payment.amount_paid);

            // Payment method - fetch from ledger entry
            await fetchPaymentType(payment.customer_phone, payment.id);

            // Display family member name if available
            if (payment.family_member_name && payment.family_member_name.trim() !== '') {
                document.getElementById('familyMemberName').textContent = payment.family_member_name;
                document.getElementById('familyMemberRow').style.display = 'flex';
            }

            if (payment.notes && payment.notes.trim() !== '') {
                document.getElementById('notes').textContent = payment.notes;
                document.getElementById('notesSection').style.display = 'block';
            }

            // Fetch and display employee who processed the payment
            if (payment.processed_by_user_id) {
                await fetchEmployeeDetails(payment.processed_by_user_id);
            }

            // Generate verification code
            generateVerificationCode(payment);
        }

        async function fetchEmployeeDetails(userId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('processedBy').textContent = user.name;
                } else {
                    document.getElementById('processedBy').textContent = 'ID: ' + userId;
                }
            } catch (error) {
                console.error('Error fetching employee details:', error);
                document.getElementById('processedBy').textContent = 'ID: ' + userId;
            }
        }

        async function fetchPaymentType(customerPhone, paymentId) {
            try {
                const token = localStorage.getItem('token');
                // Query ledger by customer phone and find the matching payment entry
                const response = await fetch(`/api/ledger/customer/${customerPhone}?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const entries = await response.json();
                    // Find entry with matching reference_id (payment ID)
                    const paymentEntry = entries.find(e =>
                        e.reference_id === paymentId &&
                        (e.entry_type === 'PAYMENT' || e.entry_type === 'ONLINE_PAYMENT')
                    );
                    if (paymentEntry) {
                        document.getElementById('paymentMethod').textContent =
                            paymentEntry.entry_type === 'ONLINE_PAYMENT' ? 'рдСрдирд▓рд╛рдЗрди' : 'рдирдХрдж';
                        return;
                    }
                }
                // Default to cash if not found
                document.getElementById('paymentMethod').textContent = 'рдирдХрдж';
            } catch (error) {
                console.error('Error fetching payment type:', error);
                document.getElementById('paymentMethod').textContent = 'рдирдХрдж';
            }
        }

        async function generateVerificationCode(payment) {
            try {
                const dataString = `${payment.receipt_number}|${payment.amount_paid}|${payment.payment_date}|${payment.customer_phone}|${payment.processed_by_user_id}`;
                const secretKey = 'COLD-STORAGE-2025-SECRET-KEY';

                const encoder = new TextEncoder();
                const data = encoder.encode(dataString);
                const key = encoder.encode(secretKey);

                const cryptoKey = await crypto.subtle.importKey(
                    'raw', key, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
                );

                const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);
                const hashArray = Array.from(new Uint8Array(signature));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                document.getElementById('verificationCode').textContent = hashHex.toUpperCase();
            } catch (error) {
                console.error('Error generating verification code:', error);
                document.getElementById('verificationCode').textContent = 'Error';
            }
        }

        // Load receipt on page load
        loadReceipt();
    </script>
</body>
</html>
