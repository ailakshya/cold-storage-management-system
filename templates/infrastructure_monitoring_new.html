<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Monitoring - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-critical { background: #ef4444; }
        .neu-border {
            border: 1px solid #e0e6ed;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/direct-connect.js"></script>
    <script src="/static/js/nav-utils.js"></script>
</head>
<body class="bg-[#f8fafb] p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="neu-border bg-white p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold flex items-center gap-3">
                        <i class="bi bi-hdd-network"></i>
                        Infrastructure Monitoring
                    </h1>
                    <p class="text-gray-600">Cold Storage Production Node Status</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600">Last Update</div>
                    <div id="lastUpdate" class="text-lg font-bold">--:--:--</div>
                    <div class="flex gap-2 mt-2">
                         <select id="timeRange" onchange="refreshHistory()" class="neu-border bg-gray-50 px-3 py-2 text-sm">
                            <option value="1h">Last 1 Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h">Last 24 Hours</option>
                        </select>
                        <button onclick="refreshAll()" class="neu-border bg-blue-500 text-white px-4 py-2 text-sm">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button onclick="goHome()" class="neu-border bg-emerald-100 text-emerald-700 px-4 py-2 text-sm">
                            <i class="bi bi-house"></i> Home
                        </button>
                        <button onclick="history.back()" class="neu-border bg-gray-200 px-4 py-2 text-sm">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">Database</div>
                <div id="dbStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">Redis Cache</div>
                <div id="redisStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">K3s Cluster</div>
                <div id="k3sStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">R2 Cloud Backup</div>
                <div id="r2Status" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
        </div>

        <!-- Node Resources -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="neu-border bg-white p-6">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-cpu text-blue-500"></i> CPU Usage
                </h3>
                <div class="flex justify-between items-end mb-2">
                    <div id="cpuUsage" class="text-4xl font-bold">--%</div>
                    <div id="cpuCores" class="text-sm text-gray-600">-- cores</div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div id="cpuBar" class="bg-blue-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <!-- Chart -->
                <div class="h-32">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
            <div class="neu-border bg-white p-6">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-memory text-green-500"></i> Memory
                </h3>
                <div class="flex justify-between items-end mb-2">
                    <div id="memUsage" class="text-4xl font-bold">--%</div>
                    <div id="memDetails" class="text-sm text-gray-600">-- / --</div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div id="memBar" class="bg-green-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <!-- Chart -->
                 <div class="h-32">
                    <canvas id="memChart"></canvas>
                </div>
            </div>
            <div class="neu-border bg-white p-6">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-hdd text-purple-500"></i> Disk
                </h3>
                <div class="flex justify-between items-end mb-2">
                    <div id="diskUsage" class="text-4xl font-bold">--%</div>
                    <div id="diskDetails" class="text-sm text-gray-600">-- / --</div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                    <div id="diskBar" class="bg-purple-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <!-- Chart -->
                <div class="h-32">
                    <canvas id="diskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PostgreSQL Info -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-database"></i> PostgreSQL Database
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <div class="text-sm text-gray-600">Active Connections</div>
                    <div id="dbConnections" class="text-2xl font-bold">--</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600">Database Size</div>
                    <div id="dbSize" class="text-2xl font-bold">--</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600">Uptime</div>
                    <div id="sysUptime" class="text-2xl font-bold">--</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600">Temp</div>
                    <div id="sysTemp" class="text-2xl font-bold">--</div>
                </div>
            </div>
        </div>

        <!-- R2 Backup Status -->
        <div class="neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-cloud"></i> Backups
            </h2>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <div class="text-sm text-gray-600">Local Backup</div>
                    <div id="localBackupStatus" class="text-xl font-bold">Checking...</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600">Last Local Snapshot</div>
                    <div id="lastLocalBackup" class="text-lg font-bold text-gray-700">--</div>
                </div>
                 <div>
                    <div class="text-sm text-gray-600">Total Snapshots</div>
                    <div id="totalSnapshots" class="text-2xl font-bold">--</div>
                </div>
                 <div>
                    <div class="text-sm text-gray-600">R2 Sync</div>
                    <div id="r2SyncStatus" class="text-xl font-bold text-blue-600">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        // Charts
        let cpuChart, memChart, diskChart;

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { beginAtZero: true, max: 100, display: false }
                },
                elements: {
                    point: { radius: 0 },
                    line: { tension: 0.4, borderWidth: 2 }
                }
            };

            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', fill: true, backgroundColor: '#3b82f620' }] },
                options: commonOptions
            });

            memChart = new Chart(document.getElementById('memChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#10b981', fill: true, backgroundColor: '#10b98120' }] },
                options: commonOptions
            });

            diskChart = new Chart(document.getElementById('diskChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#a855f7', fill: true, backgroundColor: '#a855f720' }] },
                options: commonOptions
            });
        }

        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        async function fetchStats() {
            try {
                // Fetch real-time dashboard data
                const res = await fetch('/api/monitoring/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                updateUI(data);
            } catch (err) {
                console.error(err);
            }
        }

        async function fetchHistory() {
            try {
                const range = document.getElementById('timeRange').value;
                const res = await fetch(`/api/monitoring/nodes/local/history?range=${range}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const history = await res.json();
                
                updateCharts(history);
            } catch (err) {
                console.error(err);
            }
        }

        function updateUI(data) {
            // Statuses
            setStatus('dbStatus', data.database_status === 'healthy', 'Healthy', 'Unhealthy');
            setStatus('redisStatus', true, 'Connected', 'Error'); // Placeholder
            setStatus('k3sStatus', true, '1/1 Node', 'Error');
            setStatus('r2Status', true, 'Active', 'Down');

            // Resources
            setResource('cpu', data.cpu_percent, null);
            setResource('mem', data.memory_percent, `${data.memory_used} / ${data.memory_total}`);
            setResource('disk', data.disk_percent, `${data.disk_used} / ${data.disk_total}`);

            // DB & System
            document.getElementById('dbConnections').textContent = data.active_connections || '--';
            document.getElementById('dbSize').textContent = data.database_size || '--';
            document.getElementById('sysUptime').textContent = data.uptime || '--';
            document.getElementById('sysTemp').textContent = data.system_temp || '--';

            // Backups
            document.getElementById('lastLocalBackup').textContent = data.last_local_backup || 'None';
            document.getElementById('totalSnapshots').textContent = data.total_snapshots || '0';
            document.getElementById('r2SyncStatus').textContent = data.r2_sync_status || 'Unknown';
            document.getElementById('localBackupStatus').textContent = (data.total_snapshots > 0) ? 'Active' : 'Empty';

            updateTimestamp();
        }
        
        function setStatus(id, healthy, goodText, badText) {
            const el = document.getElementById(id);
            if (healthy) {
                el.innerHTML = `<div class="w-4 h-4 rounded-full status-healthy"></div><span class="font-bold">${goodText}</span>`;
            } else {
                el.innerHTML = `<div class="w-4 h-4 rounded-full status-critical"></div><span class="font-bold">${badText}</span>`;
            }
        }

        function setResource(prefix, percent, details) {
            document.getElementById(`${prefix}Usage`).textContent = (percent || 0).toFixed(1) + '%';
            document.getElementById(`${prefix}Bar`).style.width = (percent || 0) + '%';
            if (details) document.getElementById(`${prefix}Details`).textContent = details;
        }

        function updateCharts(history) {
            if (history.cpu) updateChart(cpuChart, history.cpu);
            if (history.mem) updateChart(memChart, history.mem);
            if (history.disk) updateChart(diskChart, history.disk);
        }

        function updateChart(chart, points) {
            if (!points) return;
            chart.data.labels = points.map(p => new Date(p.time).toLocaleTimeString());
            chart.data.datasets[0].data = points.map(p => p.value);
            chart.update();
        }

        function refreshAll() {
            fetchStats();
            fetchHistory();
        }
        
        function refreshHistory() {
            fetchHistory();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            refreshAll();
            setInterval(fetchStats, 5000); // Fast update for live data
            setInterval(fetchHistory, 60000); // Slow update for charts
        });
    </script>
</body>
</html>
