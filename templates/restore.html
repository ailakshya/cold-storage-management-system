<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point-in-Time Restore - Cold Storage</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">
    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .neu-button {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-card {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
        }
        .date-card {
            padding: 1rem;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        .date-card:hover { border-color: #4a90a4; background: #f0f9ff; }
        .date-card.selected { border-color: #4a90a4; background: #e0f2fe; }
        .snapshot-row {
            padding: 0.75rem 1rem;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        .snapshot-row:hover { background: #f0f9ff; border-color: #4a90a4; }
        .snapshot-row.selected { background: #dbeafe; border-color: #3b82f6; }
        .time-badge {
            background: #4a90a4;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .warning-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
        }
        .danger-box {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 1.5rem;
        }
        .confirmation-input {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 0.2rem;
            text-transform: uppercase;
            padding: 1rem;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
        }
        .confirmation-input:focus { border-color: #ef4444; outline: none; }
        .progress-bar {
            height: 8px;
            background: #e0e6ed;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #4a90a4;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (max-width: 1023px) and (orientation: portrait) {
            body { font-size: 0.875rem; }
            .stat-card { padding: 0.75rem; }
            .stat-card p.text-3xl { font-size: 1.25rem; }
            h1 { font-size: 1.25rem !important; }
        }
    </style>
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/nav-utils.js"></script>
    <script src="/static/js/direct-connect.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <i class="bi bi-clock-history text-orange-600"></i>
                    Point-in-Time Restore
                </h1>
                <p class="text-gray-600 mt-2 text-sm md:text-base">Restore database to any previous point in time from R2 snapshots</p>
            </div>
            <div class="flex gap-2 md:gap-4 w-full md:w-auto justify-end">
                <button onclick="theme.toggle()" class="neu-button bg-gray-200" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="openSettings()" class="neu-button bg-gray-600 text-white">
                    <i class="bi bi-gear-fill"></i> Settings
                </button>
                <button onclick="createBackup()" class="neu-button bg-green-500 text-white" id="createBackupBtn">
                    <i class="bi bi-plus-circle"></i> Create Backup
                </button>
                <button onclick="loadDates()" class="neu-button bg-blue-500 text-white">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button onclick="goHome()" class="neu-button bg-emerald-100 text-emerald-700">
                    <i class="bi bi-house"></i> Home
                </button>
                <button onclick="history.back()" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </header>

        <!-- Source Selection Tabs -->
        <div class="flex gap-4 mb-6">
            <button onclick="switchTab('cloud')" id="tab-cloud" class="neu-button bg-blue-500 text-white flex-1 transition-colors">
                <i class="bi bi-cloud-arrow-down-fill mr-2"></i> Cloud Snapshots (R2)
            </button>
            <button onclick="switchTab('local')" id="tab-local" class="neu-button bg-gray-200 text-gray-700 flex-1 transition-colors">
                <i class="bi bi-hdd-fill mr-2"></i> Local Backups
            </button>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card bg-blue-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Snapshots</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalSnapshots">-</p>
                    </div>
                    <i class="bi bi-database text-4xl text-blue-600"></i>
                </div>
            </div>
            <div class="stat-card bg-green-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Available Dates</p>
                        <p class="text-3xl font-bold text-green-600" id="totalDates">-</p>
                    </div>
                    <i class="bi bi-calendar3 text-4xl text-green-600"></i>
                </div>
            </div>
            <div class="stat-card bg-orange-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600" id="statFreqLabel">Cloud Backup Frequency</p>
                        <p class="text-3xl font-bold text-orange-600" id="statFreq">-</p>
                    </div>
                    <i class="bi bi-clock text-4xl text-orange-600"></i>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Step 1: Select Date -->
            <div class="neu-border bg-white p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">1</span>
                    Select Date
                </h2>
                <div id="dateList" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <i class="bi bi-hourglass-split text-4xl"></i>
                        <p class="mt-2">Loading dates...</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: Select Time -->
            <div class="neu-border bg-white p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">2</span>
                    Select Time
                </h2>
                <div id="snapshotList" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <i class="bi bi-calendar-date text-4xl"></i>
                        <p class="mt-2">Select a date first</p>
                    </div>
                </div>
            </div>

            <!-- Step 3: Confirm & Restore -->
            <div class="neu-border bg-white p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm">3</span>
                    Confirm & Restore
                </h2>
                <div id="confirmPanel">
                    <div class="text-center text-gray-500 py-8">
                        <i class="bi bi-clock-history text-4xl"></i>
                        <p class="mt-2">Select a snapshot to restore</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Warning Box -->
        <div class="warning-box mt-8">
            <div class="flex items-start gap-4">
                <i class="bi bi-exclamation-triangle-fill text-3xl text-amber-600"></i>
                <div>
                    <h3 class="font-bold text-lg text-amber-800">Important Information</h3>
                    <ul class="mt-2 text-amber-700 space-y-1">
                        <li><i class="bi bi-check-circle"></i> A backup of current data will be created before restore</li>
                        <li><i class="bi bi-check-circle"></i> Restore will replace ALL current data with snapshot data</li>
                        <li><i class="bi bi-check-circle"></i> This action cannot be undone (except by restoring another snapshot)</li>
                        <li><i class="bi bi-check-circle"></i> Rate limited to 1 restore per 5 minutes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="danger-box mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <i class="bi bi-exclamation-octagon-fill text-2xl text-red-600"></i>
                    <h3 class="font-bold text-lg text-red-800">Confirm Database Restore</h3>
                </div>
                <p class="text-red-700">You are about to restore the database to:</p>
                <p class="font-bold text-xl mt-2" id="modalSnapshotTime">-</p>
                <p class="text-sm text-red-600 mt-2" id="modalSnapshotSize">-</p>
            </div>

            <p class="mb-4 text-gray-700">Type <strong>RESTORE</strong> to confirm:</p>
            <input type="text" id="confirmInput" class="confirmation-input w-full mb-4" placeholder="Type RESTORE">

            <div class="flex gap-4">
                <button onclick="closeModal()" class="neu-button bg-gray-200 flex-1">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button onclick="executeRestore()" id="restoreBtn" class="neu-button bg-red-500 text-white flex-1" disabled>
                    <i class="bi bi-arrow-counterclockwise"></i> Restore Now
                </button>
            </div>

            <div id="restoreProgress" class="hidden mt-6">
                <p class="text-center text-gray-600 mb-2">Restoring database...</p>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-2xl">Backup Settings</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>

            <form id="settingsForm" onsubmit="saveSettings(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">R2/Cloud Backup Interval (Minutes)</label>
                    <input type="number" name="r2_interval" id="settingR2Interval" class="w-full p-2 border border-gray-300 rounded-md" min="1" required>
                    <p class="text-xs text-gray-500 mt-1">Saves snapshot to remote R2 storage.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Local Backup Interval (Minutes)</label>
                    <input type="number" name="local_interval" id="settingLocalInterval" class="w-full p-2 border border-gray-300 rounded-md" min="1" required>
                    <p class="text-xs text-gray-500 mt-1">Saves snapshot to local disk.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Local Retention</label>
                    <div class="flex gap-2">
                        <input type="number" name="local_retention_val" id="settingLocalRetentionVal" class="w-2/3 p-2 border border-gray-300 rounded-md" min="0" required>
                        <select id="settingLocalRetentionUnit" class="w-1/3 p-2 border border-gray-300 rounded-md">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                            <option value="months">Months</option>
                            <option value="years">Years</option>
                        </select>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Backups older than this will be deleted. Set to 0 to keep forever.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Restore Rate Limit (Minutes)</label>
                    <input type="number" name="restore_rate_limit" id="settingRestoreRateLimit" class="w-full p-2 border border-gray-300 rounded-md" min="1" required>
                    <p class="text-xs text-gray-500 mt-1">Minimum time between database restore operations (prevents accidental multiple restores).</p>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeSettings()" class="neu-button bg-gray-200 flex-1">Cancel</button>
                    <button type="submit" class="neu-button bg-blue-500 text-white flex-1">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        let currentTab = 'cloud';
        let selectedDate = null;
        let selectedSnapshot = null;
        let confirmationToken = null;
        let localBackupsCache = []; // To store local backups and grouping them client-side

        // Settings Modal Functions
        function openSettings() {
            loadSettings();
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/restore/config', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                document.getElementById('settingR2Interval').value = data.r2_interval_minutes;
                document.getElementById('settingLocalInterval').value = data.local_interval_minutes;
                document.getElementById('settingRestoreRateLimit').value = data.restore_rate_limit_minutes || 5;

                // Convert retention minutes to appropriate unit
                const minutes = data.local_retention_minutes;
                let val = minutes;
                let unit = 'minutes';

                if (minutes > 0) {
                    const minPerYear = 60 * 24 * 365;
                    const minPerMonth = 60 * 24 * 30; // approx
                    const minPerDay = 60 * 24;
                    const minPerHour = 60;

                    if (minutes % minPerYear === 0) {
                        val = minutes / minPerYear;
                        unit = 'years';
                    } else if (minutes % minPerMonth === 0) {
                        val = minutes / minPerMonth;
                        unit = 'months';
                    } else if (minutes % minPerDay === 0) {
                        val = minutes / minPerDay;
                        unit = 'days';
                    } else if (minutes % minPerHour === 0) {
                        val = minutes / minPerHour;
                        unit = 'hours';
                    }
                }

                document.getElementById('settingLocalRetentionVal').value = val;
                document.getElementById('settingLocalRetentionUnit').value = unit;

            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Failed to load settings');
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            // Calculate minutes
            const val = parseInt(document.getElementById('settingLocalRetentionVal').value);
            const unit = document.getElementById('settingLocalRetentionUnit').value;
            let retentionMinutes = val;

            if (val > 0) {
                switch(unit) {
                    case 'hours': retentionMinutes = val * 60; break;
                    case 'days': retentionMinutes = val * 60 * 24; break;
                    case 'months': retentionMinutes = val * 60 * 24 * 30; break;
                    case 'years': retentionMinutes = val * 60 * 24 * 365; break;
                }
            }

            const config = {
                r2_interval_minutes: parseInt(document.getElementById('settingR2Interval').value),
                local_interval_minutes: parseInt(document.getElementById('settingLocalInterval').value),
                local_retention_minutes: retentionMinutes,
                restore_rate_limit_minutes: parseInt(document.getElementById('settingRestoreRateLimit').value)
            };

            try {
                const response = await fetch('/api/admin/restore/config', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    alert('Settings updated successfully!');
                    closeSettings();
                    loadData(true); // Refresh data and stats
                } else {
                    const data = await response.text();
                    try {
                         const json = JSON.parse(data);
                         alert('Failed: ' + (json.error || 'Unknown error'));
                    } catch {
                         alert('Failed: ' + data);
                    }
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Switch between Cloud and Local tabs
        function switchTab(tab) {
            currentTab = tab;
            selectedDate = null;
            selectedSnapshot = null;
            confirmationToken = null;

            // Update UI tabs
            if (tab === 'cloud') {
                document.getElementById('tab-cloud').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('tab-cloud').classList.add('bg-blue-500', 'text-white');
                document.getElementById('tab-local').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('tab-local').classList.add('bg-gray-200', 'text-gray-700');
            } else {
                document.getElementById('tab-local').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('tab-local').classList.add('bg-blue-500', 'text-white');
                document.getElementById('tab-cloud').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('tab-cloud').classList.add('bg-gray-200', 'text-gray-700');
            }

            // Reset panels
            document.getElementById('snapshotList').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="bi bi-calendar-date text-4xl"></i>
                    <p class="mt-2">Select a date first</p>
                </div>
            `;
            document.getElementById('confirmPanel').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="bi bi-clock-history text-4xl"></i>
                    <p class="mt-2">Select a snapshot to restore</p>
                </div>
            `;

            // Load data
            loadData();
        }

        let backupConfig = null;

        function loadData(refreshStats = false) {
             if (currentTab === 'cloud') {
                loadCloudBackups();
            } else {
                loadLocalBackups();
            }
            if (refreshStats || !backupConfig) {
                loadStats();
            } else {
                updateFrequencyDisplay();
            }
        }

        async function loadStats() {
             try {
                const response = await fetch('/api/admin/restore/config', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                backupConfig = data;
                updateFrequencyDisplay();
            } catch (e) {
                console.log("Failed to load stats", e);
            }
        }

        function updateFrequencyDisplay() {
            if (!backupConfig) return;
            const element = document.getElementById('statFreq');
            const label = document.getElementById('statFreqLabel');
            
            if (currentTab === 'cloud') {
                element.textContent = backupConfig.r2_interval_minutes + " min";
                label.textContent = "Cloud Backup Frequency";
            } else {
                element.textContent = backupConfig.local_interval_minutes + " min";
                label.textContent = "Local Backup Frequency";
            }
        }

        // Load Cloud (R2) Backups
        async function loadCloudBackups() {
            try {
                const dateList = document.getElementById('dateList');
                dateList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="bi bi-hourglass-split text-4xl"></i>
                        <p class="mt-2">Loading cloud backups...</p>
                    </div>
                `;

                const response = await fetch('/api/admin/restore/snapshots', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load cloud backups');
                }

                document.getElementById('totalSnapshots').textContent = data.total_backups.toLocaleString();
                document.getElementById('totalDates').textContent = data.dates.length;

                renderDateList(data.dates);
            } catch (error) {
                console.error('Error loading cloud backups:', error);
                document.getElementById('dateList').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="bi bi-exclamation-triangle text-4xl"></i>
                        <p class="mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Load Local Backups
        async function loadLocalBackups() {
            try {
                const dateList = document.getElementById('dateList');
                dateList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="bi bi-hourglass-split text-4xl"></i>
                        <p class="mt-2">Loading local backups...</p>
                    </div>
                `;

                const response = await fetch('/api/admin/restore/local', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load local backups');
                }

                localBackupsCache = data.backups;
                document.getElementById('totalSnapshots').textContent = data.count.toLocaleString();
                
                // Group local backups by date
                const datesMap = {};
                if (!localBackupsCache) localBackupsCache = [];
                
                localBackupsCache.forEach(backup => {
                    const date = backup.mod_time_str.split(' ')[0]; // Extract YYYY-MM-DD
                    const time = backup.mod_time_str.split(' ')[1];
                    
                    if (!datesMap[date]) {
                        datesMap[date] = {
                            date: date,
                            count: 0,
                            times: []
                        };
                    }
                    datesMap[date].count++;
                    datesMap[date].times.push(time);
                });

                const dates = Object.values(datesMap).map(d => {
                    d.times.sort();
                    d.earliest_time = d.times[0];
                    d.latest_time = d.times[d.times.length - 1];
                    return d;
                }).sort((a, b) => b.date.localeCompare(a.date));

                document.getElementById('totalDates').textContent = dates.length;
                renderDateList(dates);

            } catch (error) {
                console.error('Error loading local backups:', error);
                document.getElementById('dateList').innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="bi bi-exclamation-triangle text-4xl"></i>
                        <p class="mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderDateList(dates) {
            const dateList = document.getElementById('dateList');
            if (dates.length === 0) {
                dateList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="bi bi-database-x text-4xl"></i>
                        <p class="mt-2">No backups found</p>
                    </div>
                `;
                return;
            }

            dateList.innerHTML = dates.map(d => `
                <div class="date-card" onclick="selectDate('${d.date}', this)">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold">${formatDate(d.date)}</p>
                            <p class="text-sm text-gray-500">${d.count} snapshots</p>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <p>${d.earliest_time} - ${d.latest_time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function selectDate(date, element) {
            selectedDate = date;
            selectedSnapshot = null;

            // Update UI
            document.querySelectorAll('.date-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            // Reset confirm panel
            document.getElementById('confirmPanel').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i class="bi bi-clock-history text-4xl"></i>
                    <p class="mt-2">Select a snapshot to restore</p>
                </div>
            `;

            if (currentTab === 'cloud') {
                await loadCloudSnapshotsForDate(date);
            } else {
                renderLocalSnapshotsForDate(date);
            }
        }

        async function loadCloudSnapshotsForDate(date) {
            try {
                document.getElementById('snapshotList').innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="bi bi-hourglass-split text-2xl"></i>
                        <p class="mt-2">Loading snapshots...</p>
                    </div>
                `;

                const response = await fetch(`/api/admin/restore/snapshots?date=${date}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load snapshots');
                }

                renderSnapshotsList(data.snapshots);
            } catch (error) {
                document.getElementById('snapshotList').innerHTML = `
                    <div class="text-center text-red-500 py-4">
                        <i class="bi bi-exclamation-triangle text-2xl"></i>
                        <p class="mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderLocalSnapshotsForDate(date) {
            // Filter local backups by date
            const snapshots = localBackupsCache
                .filter(b => b.mod_time_str.startsWith(date))
                .map(b => ({
                    key: b.filename,
                    timestamp: b.mod_time_str.split(' ')[1],
                    size: b.size
                }))
                .sort((a, b) => b.timestamp.localeCompare(a.timestamp)); // Newest time first

            renderSnapshotsList(snapshots);
        }

        function renderSnapshotsList(snapshots) {
            const snapshotList = document.getElementById('snapshotList');
            if (snapshots.length === 0) {
                 snapshotList.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p class="mt-2">No snapshots found for this date</p>
                    </div>
                `;
                return;
            }

            snapshotList.innerHTML = snapshots.map(s => `
                <div class="snapshot-row" onclick="selectSnapshot('${s.key}', '${s.timestamp}', ${s.size}, this)">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="time-badge">${s.timestamp}</span>
                            ${currentTab === 'local' ? `<span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600 truncate max-w-[150px]" title="${s.key}">${s.key}</span>` : ''}
                        </div>
                        <span class="text-sm text-gray-600">${formatSize(s.size)}</span>
                    </div>
                </div>
            `).join('');
        }

        async function selectSnapshot(key, timestamp, size, element) {
            selectedSnapshot = { key, timestamp, size };

            // Update UI
            document.querySelectorAll('.snapshot-row').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            // Show confirm panel
            document.getElementById('confirmPanel').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Selected Restore Point (${currentTab === 'cloud' ? 'Cloud' : 'Local'})</p>
                        <p class="font-bold text-xl text-blue-700">${formatDate(selectedDate)} ${timestamp}</p>
                        <p class="text-sm text-gray-500 mt-1">${formatSize(size)}</p>
                        ${currentTab === 'local' ? `<p class="text-xs text-gray-400 mt-1 truncate" title="${key}">${key}</p>` : ''}
                    </div>
                    <button onclick="previewRestore()" class="neu-button bg-orange-500 text-white w-full">
                        <i class="bi bi-eye"></i> Preview Restore
                    </button>
                    ${currentTab === 'local' ? `
                    <button onclick="deleteLocalBackup('${key}')" class="neu-button bg-red-100 text-red-600 w-full hover:bg-red-200">
                        <i class="bi bi-trash"></i> Delete Backup
                    </button>
                    ` : ''}
                </div>
            `;
        }
        
        async function deleteLocalBackup(filename) {
            if (!confirm(`Are you sure you want to PERMANENTLY delete this local backup?\n\nFile: ${filename}`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/restore/local?filename=${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Backup deleted successfully');
                    // Refresh the list
                    selectedSnapshot = null;
                    document.getElementById('confirmPanel').innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="bi bi-clock-history text-4xl"></i>
                            <p class="mt-2">Select a snapshot to restore</p>
                        </div>
                    `;
                    loadLocalBackups(); // Reload list
                } else {
                    alert('Failed to delete: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error deleting backup: ' + e.message);
            }
        }

        async function previewRestore() {
            if (!selectedSnapshot) return;
            
            const endpoint = currentTab === 'cloud' 
                ? '/api/admin/restore/preview' 
                : '/api/admin/restore/local/preview';
            
            const payload = currentTab === 'cloud'
                ? { snapshot_key: selectedSnapshot.key }
                : { filename: selectedSnapshot.key };

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to preview restore');
                }

                confirmationToken = data.preview.confirmation_token;

                // Show modal
                document.getElementById('modalSnapshotTime').textContent =
                    `${formatDate(selectedDate)} ${selectedSnapshot.timestamp}`;
                document.getElementById('modalSnapshotSize').textContent =
                    `Size: ${data.preview.size_formatted} | Token expires in ${data.preview.expires_in_seconds}s`;
                document.getElementById('confirmInput').value = '';
                document.getElementById('restoreBtn').disabled = true;
                document.getElementById('restoreProgress').classList.add('hidden');
                document.getElementById('confirmModal').classList.add('active');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        document.getElementById('confirmInput').addEventListener('input', function(e) {
            const isValid = e.target.value.toUpperCase() === 'RESTORE';
            document.getElementById('restoreBtn').disabled = !isValid;
        });

        async function executeRestore() {
            if (!selectedSnapshot || !confirmationToken) return;

            const endpoint = currentTab === 'cloud' 
                ? '/api/admin/restore/execute' 
                : '/api/admin/restore/local/execute';

            const payload = currentTab === 'cloud'
                ? { snapshot_key: selectedSnapshot.key, confirmation_token: confirmationToken }
                : { filename: selectedSnapshot.key, confirmation_token: confirmationToken };

            try {
                document.getElementById('restoreProgress').classList.remove('hidden');
                document.getElementById('restoreBtn').disabled = true;

                // Animate progress bar
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress > 90) progress = 90;
                    document.getElementById('progressFill').style.width = progress + '%';
                }, 500);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                clearInterval(progressInterval);
                document.getElementById('progressFill').style.width = '100%';

                if (!data.success) {
                    throw new Error(data.error || 'Restore failed');
                }

                setTimeout(() => {
                    alert('Database restored successfully!\n\nPre-restore backup: ' + data.result.pre_restore_backup);
                    closeModal();
                    if (currentTab === 'cloud') {
                        loadCloudBackups();
                    } else {
                        loadLocalBackups();
                    }
                }, 500);
            } catch (error) {
                document.getElementById('restoreProgress').classList.add('hidden');
                alert('Restore failed: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            confirmationToken = null;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Close modal on outside click
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        async function createBackup() {
            if (!confirm('Create a new backup now? This will be saved locally and uploaded to R2.')) return;
            
            const btn = document.getElementById('createBackupBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Creating...';

            try {
                const response = await fetch('/api/admin/restore/create', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();

                if (data.success) {
                    alert('Backup created successfully!\n\nKey: ' + data.key);
                    // Refresh current view
                    if (currentTab === 'cloud') {
                        loadCloudBackups();
                    } else {
                        loadLocalBackups();
                    }
                } else {
                    alert('Failed to create backup: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error creating backup: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // Load data on page load (default to cloud)
        loadData(true);
    </script></body>
</html>
