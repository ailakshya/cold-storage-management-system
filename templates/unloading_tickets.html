<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-page-title="page_title_unloading">Unloading Tickets - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .neu-input {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 8px;
            background-color: #ffffff;
            color: #2c3e50;
            transition: all 0.2s ease;
            background-color: #ffffff;
            color: #2c3e50;
        }
        .neu-input:focus {
            outline: none;
            border-color: #4a90a4;
            box-shadow: 0 0 0 3px rgba(74, 144, 164, 0.15);
        }
        .neu-button {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .neu-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .hidden { display: none; }
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clickable-row:hover {
            background-color: #FEF3C7;
        }
        .selected-ticket {
            background-color: #FDE68A !important;
            border-left: 4px solid #F59E0B;
        }
        .lang-selector {
            border: 1px solid var(--border-color, #e0e6ed);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen">
    <!-- Navigation Bar -->
    <div class="page-nav">
        <a href="{{.DashboardURL}}" class="nav-btn nav-btn-dashboard">
            <i class="bi bi-house"></i>
            <span data-i18n="dashboard">Dashboard</span>
        </a>
        <div class="flex items-center gap-2">
            <select id="langSelector" onchange="i18n.setLanguage(this.value)" class="lang-toggle">
                <option value="en">EN</option>
                <option value="hi">‡§π‡§ø‡§Ç</option>
            </select>
            <button onclick="history.back()" class="nav-btn nav-btn-back">
                <span data-i18n="back">Back</span>
                <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <i class="bi bi-ticket-perforated text-3xl md:text-4xl text-purple-600"></i>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold" data-i18n="unloading_title">Unloading Tickets</h1>
                        <p class="text-gray-600 text-sm md:text-base" data-i18n="approve_process_passes">Approve and process gate passes</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 items-center w-full md:w-auto justify-end">
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="nav-btn nav-btn-back" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
            </div>
        </header>

        <!-- Top: Pending Gate Passes (Full Width) -->
        <div class="neu-border bg-white p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-list-check text-yellow-600"></i>
                    <span data-i18n="pending_gate_passes">Pending Gate Passes</span>
                </h2>
                <button onclick="loadPendingGatePasses()" class="neu-button bg-blue-500 text-white text-sm px-3 py-2">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div id="pendingTicketsTop" class="overflow-auto" style="max-height: 300px;">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok</th>
                            <th class="text-left p-2 font-bold" data-i18n="customer_name">Customer</th>
                            <th class="text-left p-2 font-bold" data-i18n="recipient">Recipient</th>
                            <th class="text-left p-2 font-bold" data-i18n="qty">Qty</th>
                            <th class="text-left p-2 font-bold" data-i18n="expires">Expires</th>
                            <th class="text-left p-2 font-bold" data-i18n="action">Action</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody">
                        <tr>
                            <td colspan="6" class="text-center p-4 text-gray-500" data-i18n="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-10 gap-4 md:gap-6">
            <!-- Left: Approval Form (60%) -->
            <div class="md:col-span-6">
                <div class="neu-border bg-white p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="bi bi-check2-circle text-green-600"></i>
                        <span data-i18n="approval_form">Approval Form</span>
                    </h2>

                    <div id="noSelection" class="p-8 text-center text-gray-500">
                        <i class="bi bi-hand-index text-6xl mb-4"></i>
                        <p data-i18n="select_gate_pass_approve">Select a gate pass to approve</p>
                    </div>

                    <form id="approvalForm" class="hidden" onsubmit="approveGatePass(event)">
                        <input type="hidden" id="gatePassId">

                        <!-- Customer Details -->
                        <div class="mb-4 p-4 bg-yellow-50 neu-border">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="thock_number">Thok NO</span>:</p>
                                    <p class="text-xl font-bold text-purple-700" id="selectedTruckNumber">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="phone">Phone</span>:</p>
                                    <p class="text-lg font-bold text-blue-600" id="selectedPhone">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="customer_name">Customer</span>:</p>
                                    <p class="font-bold" id="selectedCustomerName">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="village">Village</span>:</p>
                                    <p class="font-bold text-green-700" id="selectedVillage">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Storage Details -->
                        <div class="mb-4 p-4 bg-blue-50 neu-border">
                            <p class="text-sm font-semibold text-gray-700 mb-2"><span data-i18n="storage_details">Storage Details</span>:</p>
                            <div class="grid grid-cols-3 md:grid-cols-3 gap-4">
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="rooms">Rooms</span>:</p>
                                    <p class="font-bold text-lg text-blue-600" id="selectedRooms">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="floors">Floors</span>:</p>
                                    <p class="font-bold text-lg text-green-600" id="selectedFloors">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="gatars">Gatars</span>:</p>
                                    <p class="font-bold text-lg text-purple-600" id="selectedGatars">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="quantity_breakdown">Quantity Breakdown</span>:</p>
                                    <p class="font-mono text-sm font-bold" id="selectedQtyBreakdown">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="remark">Remark</span>:</p>
                                    <p class="font-bold text-red-600" id="selectedRemark">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Media Section -->
                        <div class="mb-4 p-4 bg-purple-50 neu-border">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-semibold text-gray-700">
                                    <i class="bi bi-camera text-purple-600"></i> Media
                                </p>
                                <button type="button" onclick="viewAllMedia()" id="viewAllMediaBtn"
                                        class="text-xs bg-purple-200 px-2 py-1 rounded hover:bg-purple-300 transition-colors">
                                    View All
                                </button>
                            </div>
                            <div id="mediaPreview" class="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto">
                                <!-- Populated by JavaScript -->
                            </div>
                            <p id="mediaCount" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <!-- Pickup History (OUT) -->
                        <div class="mb-4 p-4 bg-red-50 neu-border" id="pickupHistorySection" style="display: none;">
                            <p class="text-sm font-semibold text-gray-700 mb-2">
                                <i class="bi bi-clock-history text-red-600"></i> <span data-i18n="pickup_history">Pickup History (OUT)</span>
                            </p>
                            <div id="pickupHistoryList" class="text-sm max-h-32 overflow-y-auto">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="mb-4 p-3 bg-white neu-border">
                            <p class="text-sm font-semibold text-gray-700 mb-2"><span data-i18n="storage_location_label">Storage Location</span>:</p>
                            <div class="grid grid-cols-2 gap-3">
                                <!-- Left: Room Selection Display -->
                                <div>
                                    <p class="text-xs text-gray-600 mb-1 font-semibold" data-i18n="room_no">Room No</p>
                                    <div class="space-y-1">
                                        <div class="grid grid-cols-2 gap-1">
                                            <div class="location-box room-2 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 2
                                            </div>
                                            <div class="location-box room-1 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 1
                                            </div>
                                        </div>
                                        <div class="location-box room-g neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                            Gallery
                                        </div>
                                        <div class="grid grid-cols-2 gap-1">
                                            <div class="location-box room-3 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 3
                                            </div>
                                            <div class="location-box room-4 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 4
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Floor Display -->
                                <div>
                                    <p class="text-xs text-gray-600 mb-1 font-semibold" data-i18n="floor">Floor</p>
                                    <div class="grid grid-cols-1 gap-1">
                                        <div class="location-box floor-5 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">5</div>
                                        <div class="location-box floor-4 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">4</div>
                                        <div class="location-box floor-3 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">3</div>
                                        <div class="location-box floor-2 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">2</div>
                                        <div class="location-box floor-1 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">1</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gatar Display -->
                            <div class="mt-3">
                                <p class="text-xs text-gray-600 mb-1 font-semibold" data-i18n="gatar_no">Gatar No</p>
                                <div class="neu-border bg-gray-100 text-gray-700 p-2 text-center font-bold" id="selectedGatar">-</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <span data-i18n="approved_quantity">Approved Quantity</span> *
                            </label>
                            <input
                                type="number"
                                id="approvedQuantity"
                                required
                                min="1"
                                class="w-full neu-input"
                                placeholder="Enter approved quantity"
                            >
                            <p class="text-xs text-gray-600 mt-1">
                                <span data-i18n="requested">Requested</span>: <span id="requestedQty" class="font-bold">-</span>
                            </p>
                        </div>

                        <!-- Pickup Gatar Selection - Visual Grid -->
                        <div class="mb-4 p-3 bg-green-50 neu-border">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-semibold text-gray-700">
                                    <i class="bi bi-geo-alt"></i> <span data-i18n="select_pickup_gatar">Select Pickup Gatar(s)</span> *
                                </label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllPickupGatars()" class="px-3 py-2 bg-blue-500 text-white rounded text-sm font-bold">
                                        <i class="bi bi-check-all"></i> <span data-i18n="select_all">All</span>
                                    </button>
                                    <button type="button" onclick="clearAllPickupGatars()" class="px-3 py-2 bg-red-100 text-red-600 rounded text-sm font-bold">
                                        <i class="bi bi-x-circle"></i> <span data-i18n="clear">Clear</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Selection Summary -->
                            <div id="pickupSelectionSummary" class="bg-white rounded p-2 mb-2 border border-green-300 text-center">
                                <p class="text-gray-500 text-sm" data-i18n="select_gate_pass_first">Select a gate pass first</p>
                            </div>

                            <!-- Gatar Grid Container -->
                            <div id="pickupGatarList" class="max-h-48 overflow-y-auto">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <input type="hidden" id="gateNo" value="">

                            <!-- Total Selected -->
                            <div class="mt-2 p-2 bg-blue-100 rounded text-center">
                                <span class="text-sm font-bold text-blue-800">
                                    <span data-i18n="total_selected">Total Selected</span>: <span id="selectedGatarCount" class="text-lg">0 <span data-i18n="items">items</span></span>
                                </span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <span data-i18n="status">Status</span> *
                            </label>
                            <select id="status" required class="w-full neu-input">
                                <option value="approved" data-i18n="approved">Approved</option>
                                <option value="rejected" data-i18n="rejected">Rejected</option>
                            </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="remarks">
                                Remarks
                            </label>
                            <textarea
                                id="approvalRemarks"
                                class="w-full neu-input"
                                rows="3"
                                placeholder="Enter remarks (optional)"
                            ></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="neu-button bg-green-500 text-white flex-1">
                                <i class="bi bi-check-circle"></i> <span data-i18n="approve">Approve</span>
                            </button>
                            <button type="button" onclick="clearSelection()" class="neu-button bg-gray-300">
                                <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Approved Gate Passes -->
                <div class="neu-border bg-white p-6 mt-8">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="bi bi-clipboard-check text-blue-600"></i>
                        <span data-i18n="approved_passes_pickup">Approved Passes - Record Pickup</span>
                    </h2>
                    <div id="approvedPasses" class="overflow-auto" style="max-height: 400px;">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-white">
                                <tr class="border-b-2 border-black">
                                    <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok</th>
                                    <th class="text-left p-2 font-bold" data-i18n="recipient">Recipient</th>
                                    <th class="text-left p-2 font-bold" data-i18n="progress">Progress</th>
                                    <th class="text-left p-2 font-bold" data-i18n="action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="approvedTableBody">
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-gray-500" data-i18n="no_approved_passes">No approved passes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right: Quick Stats (40%) -->
            <div class="md:col-span-4">
                <div class="neu-border bg-white p-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 mb-3">
                        <i class="bi bi-speedometer2 text-blue-600"></i>
                        <span data-i18n="quick_stats">Quick Stats</span>
                    </h2>
                    <div class="space-y-3">
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <p class="text-sm text-gray-600" data-i18n="pending_count">Pending</p>
                            <p id="statPending" class="text-2xl font-bold text-yellow-600">0</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <p class="text-sm text-gray-600" data-i18n="approved_count">Approved</p>
                            <p id="statApproved" class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                            <p class="text-sm text-gray-600" data-i18n="completed_today">Completed Today</p>
                            <p id="statCompleted" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom: Recent Gate Passes (Full Width) -->
        <div class="neu-border bg-white p-4 mt-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-clock-history text-green-600"></i>
                    <span data-i18n="recent_gate_passes">Recent Gate Passes</span>
                </h2>
                <button onclick="loadRecentGatePasses()" class="neu-button bg-green-500 text-white text-sm px-3 py-2">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div id="recentTickets" class="overflow-auto" style="max-height: 300px;">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok</th>
                            <th class="text-left p-2 font-bold" data-i18n="customer_name">Customer</th>
                            <th class="text-left p-2 font-bold" data-i18n="recipient">Recipient</th>
                            <th class="text-left p-2 font-bold" data-i18n="qty">Qty</th>
                            <th class="text-left p-2 font-bold" data-i18n="status">Status</th>
                            <th class="text-left p-2 font-bold" data-i18n="date">Date</th>
                        </tr>
                    </thead>
                    <tbody id="recentTableBody">
                        <tr>
                            <td colspan="6" class="text-center p-4 text-gray-500" data-i18n="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Record Pickup Modal -->
    <div id="pickupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="neu-border bg-white p-4 md:p-8 max-w-md w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i class="bi bi-box-arrow-up text-green-600"></i>
                <span data-i18n="record_pickup_title">Record Pickup</span>
            </h3>
            <form id="pickupForm" onsubmit="submitPickup(event)">
                <input type="hidden" id="pickupGatePassId">

                <div class="mb-4 p-3 md:p-4 bg-blue-50 neu-border">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600"><span data-i18n="thock">Thok</span>:</p>
                            <p class="font-bold text-xl" id="pickupThockNumber"></p>
                            <p class="text-sm text-gray-600 mt-2"><span data-i18n="recipient">Recipient</span>:</p>
                            <p class="font-bold text-purple-600" id="pickupRecipient"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600"><span data-i18n="approved">Approved</span>:</p>
                            <p class="font-bold" id="pickupApprovedQty"></p>
                            <p class="text-sm text-gray-600 mt-1"><span data-i18n="pickup">Picked Up</span>:</p>
                            <p class="font-bold text-green-600" id="pickupAlreadyPickedUp"></p>
                            <p class="text-sm text-gray-600 mt-1"><span data-i18n="remaining_quantity">Remaining</span>:</p>
                            <p class="font-bold text-orange-600" id="pickupRemaining"></p>
                        </div>
                    </div>
                </div>

                <!-- Storage Location -->
                <div class="mb-4 p-4 bg-yellow-50 neu-border">
                    <p class="text-sm font-semibold text-gray-700 mb-2">üìç <span data-i18n="storage_location_items">Storage Location (Items are stored here)</span>:</p>
                    <div id="storageLocationInfo" class="text-center">
                        <span class="text-gray-500" data-i18n="loading">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span data-i18n="pickup_quantity">Pickup Quantity</span> *
                    </label>
                    <input
                        type="number"
                        id="pickupQuantity"
                        required
                        min="1"
                        class="w-full neu-input"
                        data-i18n-placeholder="enter_pickup_qty"
                        placeholder="Enter quantity being picked up now"
                    >
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="room_no">Room No</label>
                        <select id="pickupRoomNo" class="w-full neu-input">
                            <option value="" data-i18n="select_room">Select Room</option>
                            <option value="1">Room 1</option>
                            <option value="2">Room 2</option>
                            <option value="3">Room 3</option>
                            <option value="4">Room 4</option>
                            <option value="G" data-i18n="gallery">Gallery</option>
                        </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="floor">Floor</label>
                        <select id="pickupFloor" class="w-full neu-input">
                            <option value="" data-i18n="select_floor">Select Floor</option>
                            <option value="1">Floor 1</option>
                            <option value="2">Floor 2</option>
                            <option value="3">Floor 3</option>
                            <option value="4">Floor 4</option>
                            <option value="5">Floor 5</option>
                        </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2"><span data-i18n="remarks">Remarks</span> (<span data-i18n="any_notes">Optional</span>)</label>
                    <textarea id="pickupRemarks" class="w-full neu-input" rows="2" data-i18n-placeholder="any_notes" placeholder="Any notes"></textarea>
                </div>

                <!-- Media Capture -->
                <div class="mb-6 border-t pt-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="bi bi-camera shadow-sm bg-green-100 p-1 rounded"></i>
                        <span data-i18n="capture_media">Capture Media</span> (<span data-i18n="optional">Optional</span>)
                    </label>

                    <!-- Separate buttons for photo and video capture (fixes Android issue) -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" onclick="document.getElementById('pickupPhotoInput').click()"
                                class="flex-1 min-w-[140px] neu-button bg-blue-500 text-white hover:bg-blue-600 py-3 px-4 text-sm md:text-base">
                            <i class="bi bi-camera-fill"></i> Take Photo
                        </button>
                        <button type="button" onclick="document.getElementById('pickupVideoInput').click()"
                                class="flex-1 min-w-[140px] neu-button bg-red-500 text-white hover:bg-red-600 py-3 px-4 text-sm md:text-base">
                            <i class="bi bi-camera-video-fill"></i> Record Video
                        </button>
                        <button type="button" onclick="document.getElementById('pickupMediaFiles').click()"
                                class="flex-1 min-w-[140px] neu-button bg-gray-500 text-white hover:bg-gray-600 py-3 px-4 text-sm md:text-base">
                            <i class="bi bi-file-earmark-image"></i> From Gallery
                        </button>
                    </div>

                    <!-- Hidden file inputs -->
                    <input type="file" id="pickupPhotoInput" accept="image/*" capture="environment"
                           onchange="handlePickupMediaCapture(this)" class="hidden">
                    <input type="file" id="pickupVideoInput" accept="video/*" capture="environment"
                           onchange="handlePickupMediaCapture(this)" class="hidden">
                    <input type="file" id="pickupMediaFiles" multiple accept="image/*,video/*"
                           onchange="previewPickupMedia(this)" class="hidden">

                    <p class="text-xs text-gray-500 mt-1">
                        Photos/videos saved as <span class="font-mono bg-gray-100 px-1 rounded">Thok_{No}_{Name}_pickup_GP{ID}_By_{Employee}_ID{EmpID}</span>
                    </p>

                    <!-- File Preview Section -->
                    <div id="pickupMediaPreview" class="hidden mt-3">
                        <div class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                            <i class="bi bi-images text-green-600"></i>
                            <span>Selected Files (<span id="pickupMediaCount">0</span>)</span>
                        </div>
                        <div id="pickupMediaThumbnails" class="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="pickupUploadProgress" class="hidden mt-2">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-green-700 font-bold" id="pickupUploadStatus">Uploading...</span>
                            <span id="pickupUploadPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="pickupUploadBar" class="bg-green-600 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="neu-button bg-green-500 text-white flex-1">
                        <i class="bi bi-check-circle"></i> <span data-i18n="record_pickup">Record Pickup</span>
                    </button>
                    <button type="button" onclick="closePickupModal()" class="neu-button bg-gray-300">
                        <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/i18n.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let selectedGatePass = null;
        let allGatePasses = [];
        let pickupRoomEntries = []; // Store room entries for pickup gatar selection

        async function loadPendingGatePasses() {
            try {
                const response = await fetch('/api/gate-passes/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load pending gate passes');
                }

                const gatePasses = await response.json();
                displayPendingTickets(gatePasses || []);

            } catch (error) {
                console.error('Error loading pending gate passes:', error);
                document.getElementById('ticketsTableBody').innerHTML =
                    `<tr><td colspan="7" class="text-center p-4 text-red-500">${i18n.t('failed_load_tickets', 'Failed to load tickets')}</td></tr>`;
            }
        }

        // Calculate remaining time until expiration
        // Get thock color based on seed/sell range - returns inline style
        function getThockColor(thockNumber) {
            if (!thockNumber) return 'color: #374151; font-weight: bold;';
            const numMatch = String(thockNumber).match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'color: #16a34a; font-weight: bold;' : 'color: #ea580c; font-weight: bold;';
            }
            return 'color: #374151; font-weight: bold;';
        }

        function getRemainingTime(expiresAt) {
            if (!expiresAt) return { text: 'N/A', color: 'text-gray-500' };

            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = expires - now;

            if (diff <= 0) {
                return { text: i18n.t('expired', 'EXPIRED').toUpperCase(), color: 'text-red-600 font-bold' };
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            let color = 'text-green-600'; // >24h
            if (hours < 6) {
                color = 'text-red-600 font-bold'; // <6h critical
            } else if (hours < 12) {
                color = 'text-orange-600 font-bold'; // <12h warning
            } else if (hours < 24) {
                color = 'text-yellow-600'; // <24h caution
            }

            return {
                text: `${hours}h ${minutes}m`,
                color: color
            };
        }

        // Extract recipient from remarks (priority) or use family_member_name
        function getRecipient(gp) {
            // First try to extract from remarks (what employee entered)
            if (gp.remarks) {
                const match = gp.remarks.match(/Recipient:\s*([^|]+)/i);
                if (match) return match[1].trim();
            }
            // Then check family_member_name
            if (gp.family_member_name && gp.family_member_name !== '-' && gp.family_member_name !== '') {
                return gp.family_member_name;
            }
            // Fallback to customer name
            return gp.customer_name || '-';
        }

        function displayPendingTickets(gatePasses) {
            const tbody = document.getElementById('ticketsTableBody');

            if (gatePasses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">${i18n.t('no_pending_tickets', 'No pending tickets')}</td></tr>`;
                return;
            }

            tbody.innerHTML = gatePasses.map(gp => {
                // Calculate remaining time
                const remaining = getRemainingTime(gp.expires_at);

                // If expired, add visual indicator
                const rowClass = gp.is_expired ? 'clickable-row border-b border-gray-200 bg-red-50 hover:bg-red-100' : 'clickable-row border-b border-gray-200 hover:bg-blue-50';

                // Color code truck number based on seed/sell
                const truckColor = getThockColor(gp.thock_number);

                // Get recipient name
                const recipient = getRecipient(gp);

                return `
                    <tr class="${rowClass} cursor-pointer"
                        onclick='selectTicket(${JSON.stringify(gp)})'>
                        <td class="p-2" style="${truckColor}">${gp.thock_number}</td>
                        <td class="p-2 text-sm truncate max-w-[100px]" title="${gp.customer_name}">${gp.customer_name}</td>
                        <td class="p-2 text-sm truncate max-w-[100px] text-purple-600 font-semibold" title="${recipient}">${recipient}</td>
                        <td class="p-2 font-bold">${gp.requested_quantity}</td>
                        <td class="p-2 text-xs font-bold ${remaining.color}">${remaining.text}</td>
                        <td class="p-2">
                            <button class="neu-button bg-green-500 text-white text-xs px-2 py-1">
                                <i class="bi bi-check"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Store selected gatars with quantities
        let selectedPickupGatars = {};

        // Load pickup gatar options for a selected gate pass
        async function loadPickupGatars(thockNumber) {
            const container = document.getElementById('pickupGatarList');
            const summaryDiv = document.getElementById('pickupSelectionSummary');
            container.innerHTML = '<p class="text-gray-500 text-sm text-center p-4">Loading storage locations...</p>';
            summaryDiv.innerHTML = '<p class="text-gray-500 text-sm">Loading...</p>';
            selectedPickupGatars = {};

            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load room entries');

                const roomEntries = await response.json();
                pickupRoomEntries = roomEntries.filter(re => re.thock_number === thockNumber);

                if (pickupRoomEntries.length === 0) {
                    container.innerHTML = '<p class="text-red-500 text-sm text-center p-4">No storage locations found for this truck</p>';
                    summaryDiv.innerHTML = '<p class="text-red-500 text-sm">No items in storage</p>';
                    return;
                }

                // Group by Room and Floor
                const grouped = {};
                pickupRoomEntries.forEach((re, idx) => {
                    const key = `R${re.room_no}-F${re.floor}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            room: re.room_no,
                            floor: re.floor,
                            entries: []
                        };
                    }
                    grouped[key].entries.push({ ...re, idx });
                });

                // Create visual grid like room configurator
                let html = '';
                let cellIndex = 0;

                Object.keys(grouped).forEach(key => {
                    const group = grouped[key];
                    const totalQty = group.entries.reduce((sum, e) => sum + e.quantity, 0);

                    html += `
                        <div class="mb-3 bg-green-50 border-2 border-green-400 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <span class="text-green-800 font-bold">
                                        <i class="bi bi-geo-alt-fill mr-1"></i>
                                        Room ${group.room} - Floor ${group.floor}
                                    </span>
                                </div>
                                <span class="text-xs text-green-700 font-bold">${totalQty} items available</span>
                            </div>

                            <!-- Gatar Number Grid -->
                            <div class="bg-white rounded-lg p-2 border border-green-300">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500">
                                        <i class="bi bi-hand-index-thumb mr-1"></i> CLICK TO SELECT, THEN ENTER QTY
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 max-h-60 overflow-y-auto">
                    `;

                    // Generate individual clickable cells for EACH gatar number
                    group.entries.forEach(re => {
                        // Split gate_no if it contains multiple numbers (comma or space separated)
                        const gateNos = re.gate_no.toString().split(/[,\s]+/).filter(g => g.trim());

                        gateNos.forEach(gateNo => {
                            const trimmedGate = gateNo.trim();
                            if (trimmedGate) {
                                html += `
                                    <div id="gatar-cell-${cellIndex}"
                                         class="gatar-cell p-2 rounded border-2 border-gray-200 transition-all bg-white"
                                         data-idx="${cellIndex}"
                                         data-room="${re.room_no}"
                                         data-floor="${re.floor}"
                                         data-gate="${trimmedGate}"
                                         data-entry-id="${re.id}">
                                        <div class="text-center cursor-pointer" onclick="toggleGatarCell(${cellIndex})">
                                            <span class="font-mono text-lg font-bold text-purple-700">${trimmedGate}</span>
                                        </div>
                                        <div id="qty-row-${cellIndex}" class="hidden mt-2">
                                            <input type="number"
                                                   id="qty-${cellIndex}"
                                                   class="w-full p-1 text-center border-2 border-green-400 rounded text-sm font-bold"
                                                   min="1"
                                                   placeholder="Qty"
                                                   onchange="updateGatarQty(${cellIndex})"
                                                   onclick="event.stopPropagation()">
                                        </div>
                                    </div>
                                `;
                                cellIndex++;
                            }
                        });
                    });

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                summaryDiv.innerHTML = '<p class="text-gray-500 text-sm">Click gatar ‚Üí Enter quantity</p>';

            } catch (error) {
                console.error('Error loading pickup gatars:', error);
                container.innerHTML = '<p class="text-red-500 text-sm text-center p-4">Failed to load storage locations</p>';
            }
        }

        function toggleGatarCell(idx) {
            const cell = document.getElementById(`gatar-cell-${idx}`);
            const qtyRow = document.getElementById(`qty-row-${idx}`);
            const qtyInput = document.getElementById(`qty-${idx}`);

            if (selectedPickupGatars[idx] !== undefined) {
                // Deselect
                delete selectedPickupGatars[idx];
                cell.classList.remove('border-green-500', 'bg-green-50');
                cell.classList.add('border-gray-200', 'bg-white');
                qtyRow.classList.add('hidden');
                qtyInput.value = '';
            } else {
                // Select - show quantity input
                selectedPickupGatars[idx] = 0;
                cell.classList.add('border-green-500', 'bg-green-50');
                cell.classList.remove('border-gray-200', 'bg-white');
                qtyRow.classList.remove('hidden');
                qtyInput.focus();
            }
            updatePickupGatarCount();
        }

        function updateGatarQty(idx) {
            const qtyInput = document.getElementById(`qty-${idx}`);
            const qty = parseInt(qtyInput.value) || 0;
            if (qty > 0) {
                selectedPickupGatars[idx] = qty;
            } else {
                selectedPickupGatars[idx] = 0;
            }
            updatePickupGatarCount();
        }

        function updatePickupGatarCount() {
            let totalItems = 0;
            let gatarDetails = [];
            let summaryParts = [];

            Object.keys(selectedPickupGatars).forEach(idx => {
                const cell = document.getElementById(`gatar-cell-${idx}`);
                if (cell) {
                    const qty = selectedPickupGatars[idx];
                    const gate = cell.dataset.gate;
                    totalItems += qty;
                    gatarDetails.push(`${gate}:${qty}`);
                    summaryParts.push(`<span class="inline-block bg-green-500 text-white px-2 py-1 rounded text-xs font-bold m-1">G${gate}: ${qty}</span>`);
                }
            });

            document.getElementById('selectedGatarCount').textContent = totalItems + ' items';
            document.getElementById('gateNo').value = gatarDetails.join(',');

            const summaryDiv = document.getElementById('pickupSelectionSummary');
            if (summaryParts.length > 0) {
                summaryDiv.innerHTML = summaryParts.join('');
            } else {
                summaryDiv.innerHTML = '<p class="text-gray-500 text-sm">Click on gatar numbers to select</p>';
            }
        }

        function selectAllPickupGatars() {
            document.querySelectorAll('.gatar-cell').forEach(cell => {
                const idx = parseInt(cell.dataset.idx);
                const qtyRow = document.getElementById(`qty-row-${idx}`);

                selectedPickupGatars[idx] = 0;
                cell.classList.add('border-green-500', 'bg-green-50');
                cell.classList.remove('border-gray-200', 'bg-white');
                qtyRow.classList.remove('hidden');
            });
            updatePickupGatarCount();
        }

        function clearAllPickupGatars() {
            document.querySelectorAll('.gatar-cell').forEach(cell => {
                const idx = parseInt(cell.dataset.idx);
                const qtyRow = document.getElementById(`qty-row-${idx}`);
                const qtyInput = document.getElementById(`qty-${idx}`);

                cell.classList.remove('border-green-500', 'bg-green-50');
                cell.classList.add('border-gray-200', 'bg-white');
                qtyRow.classList.add('hidden');
                if (qtyInput) qtyInput.value = '';
            });
            selectedPickupGatars = {};
            updatePickupGatarCount();
        }

        function selectTicket(gatePass) {
            selectedGatePass = gatePass;

            // Remove previous selection
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.classList.remove('selected-ticket');
            });

            // Add selection to clicked row
            event.currentTarget.classList.add('selected-ticket');

            // Show approval form
            document.getElementById('noSelection').classList.add('hidden');
            document.getElementById('approvalForm').classList.remove('hidden');

            // Fill form
            document.getElementById('gatePassId').value = gatePass.id;
            document.getElementById('selectedTruckNumber').textContent = gatePass.thock_number;
            document.getElementById('selectedPhone').textContent = gatePass.customer_phone || '-';
            document.getElementById('selectedCustomerName').textContent = gatePass.customer_name || '-';
            document.getElementById('selectedVillage').textContent = gatePass.customer_village || '-';
            document.getElementById('selectedRooms').textContent = gatePass.rooms || '-';
            document.getElementById('selectedFloors').textContent = gatePass.floors || '-';
            document.getElementById('selectedGatars').textContent = gatePass.gatars || '-';
            document.getElementById('selectedRemark').textContent = gatePass.remark || '-';

            // Format quantity breakdown: "302 (30, 30, 30, ...)"
            const totalQty = gatePass.total_qty || gatePass.requested_quantity;
            const breakdown = gatePass.qty_breakdown || '';
            document.getElementById('selectedQtyBreakdown').textContent =
                breakdown ? `${totalQty} (${breakdown})` : `${totalQty}`;

            document.getElementById('requestedQty').textContent = gatePass.requested_quantity;
            document.getElementById('approvedQuantity').value = gatePass.requested_quantity;

            // Fill location information - Reset all boxes first
            document.querySelectorAll('.location-box').forEach(box => {
                box.classList.remove('bg-red-500', 'text-white');
                box.classList.add('bg-gray-100', 'text-gray-400');
            });

            // Highlight rooms from aggregated data
            if (gatePass.rooms) {
                const roomList = gatePass.rooms.split(',').map(r => r.trim().toLowerCase());
                roomList.forEach(room => {
                    let roomClass = `.room-${room}`;
                    if (room === 'g' || room === 'gallery') roomClass = '.room-g';
                    const roomBox = document.querySelector(roomClass);
                    if (roomBox) {
                        roomBox.classList.remove('bg-gray-100', 'text-gray-400');
                        roomBox.classList.add('bg-red-500', 'text-white');
                    }
                });
            }

            // Highlight floors from aggregated data
            if (gatePass.floors) {
                const floorList = gatePass.floors.split(',').map(f => f.trim());
                floorList.forEach(floor => {
                    const floorBox = document.querySelector(`.floor-${floor}`);
                    if (floorBox) {
                        floorBox.classList.remove('bg-gray-100', 'text-gray-400');
                        floorBox.classList.add('bg-red-500', 'text-white');
                    }
                });
            }

            // Display gatar in the location box
            const gatarElement = document.getElementById('selectedGatar');
            if (gatePass.gatars) {
                gatarElement.textContent = gatePass.gatars;
                gatarElement.classList.remove('bg-gray-100', 'text-gray-700');
                gatarElement.classList.add('bg-red-500', 'text-white');
            } else {
                gatarElement.textContent = '-';
                gatarElement.classList.remove('bg-red-500', 'text-white');
                gatarElement.classList.add('bg-gray-100', 'text-gray-700');
            }

            // Load pickup gatar options
            loadPickupGatars(gatePass.thock_number);

            // Load pickup history by thock number (shows all historical pickups)
            loadPickupHistory(gatePass.thock_number);

            // Load media for this thock
            loadMediaForGatePass(gatePass.thock_number, gatePass.id);
        }

        // Format date/time for display
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load and display pickup history for a thock number (across all gate passes)
        async function loadPickupHistory(thockNumber) {
            try {
                const res = await fetch(`/api/gate-passes/pickups/by-thock?thock_number=${encodeURIComponent(thockNumber)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const pickups = await res.json();
                    displayPickupHistory(pickups);
                } else {
                    document.getElementById('pickupHistorySection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading pickup history:', error);
                document.getElementById('pickupHistorySection').style.display = 'none';
            }
        }

        function displayPickupHistory(pickups) {
            const section = document.getElementById('pickupHistorySection');
            const list = document.getElementById('pickupHistoryList');

            if (!pickups || pickups.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = pickups.map(p => {
                // Format gatar breakdown if available
                let gatarHtml = '';
                if (p.gatar_breakdown && p.gatar_breakdown.length > 0) {
                    const gatarList = p.gatar_breakdown.map(g =>
                        `<span class="bg-purple-100 text-purple-700 px-1 rounded">G${g.gatar_no}: ${g.quantity}</span>`
                    ).join(' ');
                    gatarHtml = `<div class="text-xs mt-1">${gatarList}</div>`;
                }

                return `
                <div class="py-2 border-b border-red-200 last:border-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold text-red-600">${p.pickup_quantity} bags</span>
                            <span class="text-gray-600 ml-2">by ${p.picked_up_by_user_name || 'Unknown'}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${formatDateTime(p.pickup_time)}
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 px-1 rounded">Room ${p.room_no || '-'}</span>
                        <span class="bg-gray-100 px-1 rounded ml-1">Floor ${p.floor || '-'}</span>
                        ${p.remarks ? `<span class="text-blue-600 ml-2">${p.remarks}</span>` : ''}
                    </div>
                    ${gatarHtml}
                </div>
            `}).join('');
        }

        // Load media when gate pass is selected
        async function loadMediaForGatePass(thockNumber, gatePassId) {
            try {
                // Fetch gate pass media and room entry edit media in parallel
                const [gpResponse, reResponse] = await Promise.all([
                    fetch(`/api/gate-passes/media/by-thock?thock_number=${encodeURIComponent(thockNumber)}`,
                        { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`/api/room-entries/media/by-thock?thock_number=${encodeURIComponent(thockNumber)}`,
                        { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                if (!gpResponse.ok) throw new Error('Failed to load media');

                const gpData = await gpResponse.json();
                let editMedia = [];
                if (reResponse.ok) {
                    const reData = await reResponse.json();
                    editMedia = reData.edit_media || [];
                }

                // Cache for reuse by viewAllMedia modal
                window.cachedMediaThock = thockNumber;
                window.cachedMediaData = { ...gpData, edit_media: editMedia };
                displayMediaPreview(gpData.entry_media || [], gpData.pickup_media || [], editMedia);
            } catch (error) {
                console.error('Error loading media:', error);
                document.getElementById('mediaPreview').innerHTML =
                    '<p class="text-xs text-red-500 col-span-4">Failed to load media</p>';
                document.getElementById('mediaCount').textContent = '';
            }
        }

        function displayMediaPreview(entryMedia, pickupMedia, editMedia = []) {
            const preview = document.getElementById('mediaPreview');
            const allMedia = [...entryMedia, ...pickupMedia, ...editMedia];

            if (allMedia.length === 0) {
                preview.innerHTML = '<p class="text-xs text-gray-400 col-span-4">No media available</p>';
                document.getElementById('mediaCount').textContent = '';
                return;
            }

            // Helper function to format timestamp
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                return date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            // Helper to get badge color based on media type
            const getBadgeColor = (mediaType) => {
                if (mediaType === 'entry') return 'bg-blue-500';
                if (mediaType === 'edit') return 'bg-orange-500';
                return 'bg-green-500'; // pickup
            };
            const getBadgeLabel = (mediaType) => {
                if (mediaType === 'entry') return 'ENTRY';
                if (mediaType === 'edit') return 'EDIT';
                return 'PICKUP';
            };

            // Store media array globally for navigation
            window.currentGatePassMedia = allMedia;

            // Show first 8 thumbnails with enhanced labels
            preview.innerHTML = allMedia.slice(0, 8).map((m, index) => `
                <div class="relative cursor-pointer hover:shadow-lg transition-all group"
                     onclick='openMediaViewer("${m.download_url}", "${m.file_type}", window.currentGatePassMedia, ${index})'>
                    ${m.file_type === 'image' ? `
                        <div class="w-full h-20 bg-black rounded-lg border-2 border-gray-300 flex items-center justify-center overflow-hidden group-hover:border-blue-400">
                            <img src="${m.download_url}"
                                 loading="lazy"
                                 class="max-w-full max-h-full object-contain"
                                 alt="${m.file_name}"
                                 onerror="this.parentElement.innerHTML='<div class=\\'w-full h-20 bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500\\'>Error</div>'">
                        </div>
                    ` : `
                        <div class="w-full h-20 bg-gray-900 rounded-lg border-2 border-gray-600 flex items-center justify-center overflow-hidden relative group-hover:border-purple-400">
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <i class="bi bi-play-circle-fill text-white text-3xl drop-shadow-lg"></i>
                                <span class="text-white text-[8px] mt-1 drop-shadow">VIDEO</span>
                            </div>
                        </div>
                    `}

                    <!-- Media Type Badge -->
                    <span class="absolute top-1 right-1 ${getBadgeColor(m.media_type)} text-white text-[9px] px-2 py-0.5 rounded-full font-bold shadow-md">
                        ${getBadgeLabel(m.media_type)}
                    </span>

                    <!-- File Type Icon -->
                    <span class="absolute top-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1.5 py-0.5 rounded">
                        <i class="bi bi-${m.file_type === 'image' ? 'image' : 'camera-video'}-fill"></i>
                    </span>

                    <!-- Uploader Info Tooltip (shows on hover) -->
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white text-[8px] px-1 py-0.5 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="truncate" title="${m.uploaded_by_user_name || 'Unknown'}">
                            <i class="bi bi-person-fill"></i> ${m.uploaded_by_user_name || 'Unknown'}
                        </div>
                        ${m.created_at ? `<div class="truncate"><i class="bi bi-clock"></i> ${formatTimestamp(m.created_at)}</div>` : ''}
                    </div>
                </div>
            `).join('');

            const countText = allMedia.length > 1 ? `${allMedia.length} media files` : '1 media file';
            const entryCount = entryMedia.length;
            const pickupCount = pickupMedia.length;
            const editCount = editMedia.length;
            let parts = [];
            if (entryCount > 0) parts.push(`${entryCount} entry`);
            if (pickupCount > 0) parts.push(`${pickupCount} pickup`);
            if (editCount > 0) parts.push(`${editCount} edit`);
            const breakdown = parts.length > 0 ? ` (${parts.join(', ')})` : '';
            document.getElementById('mediaCount').textContent = countText + breakdown;
        }

        // Global state for media navigation
        let currentMediaArray = [];
        let currentMediaIndex = 0;

        function openMediaViewer(url, type, mediaArray = null, index = 0) {
            // Store media array for navigation
            if (mediaArray && mediaArray.length > 0) {
                currentMediaArray = mediaArray;
                currentMediaIndex = index;
            } else {
                currentMediaArray = [{download_url: url, file_type: type}];
                currentMediaIndex = 0;
            }

            // Remove existing modal if any
            const existingModal = document.getElementById('mediaViewerModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'mediaViewerModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-95';
            modal.style.zIndex = '200';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    document.body.style.overflow = '';
                }
            };

            // Prevent body scroll on mobile when modal is open
            document.body.style.overflow = 'hidden';

            renderMediaViewer(modal);
            document.body.appendChild(modal);

            // Keyboard navigation
            window.mediaViewerKeyHandler = (e) => {
                if (e.key === 'ArrowLeft') navigateMedia(-1);
                else if (e.key === 'ArrowRight') navigateMedia(1);
                else if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', window.mediaViewerKeyHandler);
                    document.body.style.overflow = '';
                }
            };
            document.addEventListener('keydown', window.mediaViewerKeyHandler);

            // Touch gesture support for swipe navigation
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;

            window.mediaViewerTouchStart = (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            };

            window.mediaViewerTouchEnd = (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipeGesture();
            };

            function handleSwipeGesture() {
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const minSwipeDistance = 50;

                // Only trigger swipe if horizontal movement is greater than vertical
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe right - go to previous
                        navigateMedia(-1);
                    } else {
                        // Swipe left - go to next
                        navigateMedia(1);
                    }
                }
            }

            modal.addEventListener('touchstart', window.mediaViewerTouchStart, { passive: true });
            modal.addEventListener('touchend', window.mediaViewerTouchEnd, { passive: true });

            // Cleanup on close
            modal.addEventListener('remove', () => {
                document.removeEventListener('keydown', window.mediaViewerKeyHandler);
                modal.removeEventListener('touchstart', window.mediaViewerTouchStart);
                modal.removeEventListener('touchend', window.mediaViewerTouchEnd);
                document.body.style.overflow = '';
            });
        }

        function renderMediaViewer(modal) {
            const currentMedia = currentMediaArray[currentMediaIndex];
            const url = currentMedia.download_url;
            const type = currentMedia.file_type;
            const totalMedia = currentMediaArray.length;
            const hasMultiple = totalMedia > 1;

            let rotation = 0;
            let scale = 1;
            const minScale = 0.5;
            const maxScale = 3;

            const controls = `
                <div class="absolute top-0 left-0 right-0 z-30 bg-gradient-to-b from-black/80 to-transparent">
                    <div class="flex items-center justify-between px-3 py-2 md:px-5 md:py-3">
                        <div class="flex flex-wrap gap-1.5 md:gap-2">
                            ${type === 'image' ? `
                                <button onclick="rotateMedia(-90)" title="Rotate Left"
                                        class="text-white bg-gray-700 hover:bg-gray-600 active:bg-gray-500 rounded-full w-12 h-12 md:w-10 md:h-10 flex items-center justify-center shadow-lg transition-all touch-manipulation">
                                    <i class="bi bi-arrow-counterclockwise text-lg md:text-base"></i>
                                </button>
                                <button onclick="rotateMedia(90)" title="Rotate Right"
                                        class="text-white bg-gray-700 hover:bg-gray-600 active:bg-gray-500 rounded-full w-12 h-12 md:w-10 md:h-10 flex items-center justify-center shadow-lg transition-all touch-manipulation">
                                    <i class="bi bi-arrow-clockwise text-lg md:text-base"></i>
                                </button>
                                <button onclick="zoomMedia(-0.2)" title="Zoom Out"
                                        class="text-white bg-gray-700 hover:bg-gray-600 active:bg-gray-500 rounded-full w-12 h-12 md:w-10 md:h-10 flex items-center justify-center shadow-lg transition-all touch-manipulation">
                                    <i class="bi bi-dash-lg text-lg md:text-base"></i>
                                </button>
                                <button onclick="zoomMedia(0.2)" title="Zoom In"
                                        class="text-white bg-gray-700 hover:bg-gray-600 active:bg-gray-500 rounded-full w-12 h-12 md:w-10 md:h-10 flex items-center justify-center shadow-lg transition-all touch-manipulation">
                                    <i class="bi bi-plus-lg text-lg md:text-base"></i>
                                </button>
                                <button onclick="resetMedia()" title="Reset View"
                                        class="text-white bg-gray-700 hover:bg-gray-600 active:bg-gray-500 rounded-full w-12 h-12 md:w-10 md:h-10 flex items-center justify-center shadow-lg transition-all touch-manipulation">
                                    <i class="bi bi-arrow-repeat text-lg md:text-base"></i>
                                </button>
                            ` : `
                                <span class="text-white text-sm font-medium px-2 py-1">${hasMultiple ? (currentMediaIndex + 1) + ' / ' + totalMedia : ''}</span>
                            `}
                        </div>
                        <button onclick="document.getElementById('mediaViewerModal').remove(); document.body.style.overflow = '';"
                                class="text-white bg-red-500 hover:bg-red-600 active:bg-red-700 rounded-lg px-5 py-2.5 md:px-4 md:py-2 flex items-center justify-center gap-2 text-base md:text-sm font-semibold shadow-lg transition-all touch-manipulation">
                            <span>Exit</span>
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            `;

            // Navigation controls (only show if multiple media)
            // Position higher for videos to avoid overlap with video controls
            const navigation = hasMultiple ? `
                <div class="absolute ${type === 'video' ? 'bottom-20 md:bottom-20' : 'bottom-4 md:bottom-4'} left-1/2 transform -translate-x-1/2 flex items-center gap-3 md:gap-4 z-10">
                    <button onclick="navigateMedia(-1)"
                            ${currentMediaIndex === 0 ? 'disabled' : ''}
                            class="text-white bg-blue-600 hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-full w-14 h-14 md:w-12 md:h-12 flex items-center justify-center text-2xl md:text-xl shadow-lg transition-all touch-manipulation"
                            aria-label="Previous media">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="bg-black bg-opacity-75 text-white px-4 py-2.5 md:px-6 md:py-2 rounded-full text-sm md:text-sm font-semibold shadow-lg">
                        ${currentMediaIndex + 1} of ${totalMedia}
                    </div>
                    <button onclick="navigateMedia(1)"
                            ${currentMediaIndex === totalMedia - 1 ? 'disabled' : ''}
                            class="text-white bg-blue-600 hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-full w-14 h-14 md:w-12 md:h-12 flex items-center justify-center text-2xl md:text-xl shadow-lg transition-all touch-manipulation"
                            aria-label="Next media">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            ` : '';

            const mediaContent = type === 'image' ? `
                <div class="flex items-center justify-center w-full h-full max-h-[calc(100vh-5rem)] px-2">
                    <img id="mediaViewerImage" src="${url}"
                         class="max-w-full max-h-full object-contain transition-transform duration-200 touch-manipulation"
                         style="transform: rotate(0deg) scale(1);">
                </div>
            ` : `
                <div class="relative w-full h-full max-h-[calc(100vh-5rem)] flex flex-col items-center justify-center bg-black overflow-hidden" id="videoPlayerContainer">
                    <video id="mediaViewerVideo" playsinline webkit-playsinline class="w-full h-full object-contain bg-black cursor-pointer">
                        <source src="${url}" type="video/mp4">
                        <source src="${url}" type="video/mov">
                        <source src="${url}">
                        Your browser does not support the video tag.
                    </video>

                    <!-- Video Controls Bar -->
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-3 md:p-4 z-20" id="videoControls">
                        <!-- Progress Bar -->
                        <div class="relative w-full h-2 bg-gray-600 rounded-full mb-3 cursor-pointer group" id="progressContainer">
                            <div class="absolute h-full bg-gray-400 rounded-full" id="bufferedBar" style="width: 0%"></div>
                            <div class="absolute h-full bg-blue-500 rounded-full" id="progressBar" style="width: 0%"></div>
                            <div class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-blue-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow" id="progressHandle" style="left: 0%"></div>
                        </div>

                        <!-- Controls Row -->
                        <div class="flex items-center gap-2 md:gap-4 text-white">
                            <!-- Play/Pause -->
                            <button id="playPauseBtn" class="hover:text-blue-400 transition w-10 h-10 flex items-center justify-center">
                                <i class="bi bi-play-fill text-2xl" id="playIcon"></i>
                            </button>

                            <!-- Time Display -->
                            <span class="text-xs md:text-sm font-mono whitespace-nowrap" id="timeDisplay">0:00 / 0:00</span>

                            <div class="flex-1"></div>

                            <!-- Skip Backward -->
                            <button onclick="window.skipMediaVideo(-10)" class="hover:text-blue-400 transition w-10 h-10 flex items-center justify-center" title="-10s">
                                <i class="bi bi-skip-backward-fill text-xl"></i>
                            </button>

                            <!-- Skip Forward -->
                            <button onclick="window.skipMediaVideo(30)" class="hover:text-blue-400 transition w-10 h-10 flex items-center justify-center" title="+30s">
                                <i class="bi bi-skip-forward-fill text-xl"></i>
                            </button>

                            <!-- Volume -->
                            <button id="volumeBtn" class="hover:text-blue-400 transition w-10 h-10 flex items-center justify-center">
                                <i class="bi bi-volume-up-fill text-xl" id="volumeIcon"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.innerHTML = `
                <div class="relative w-full h-full flex items-center justify-center">
                    ${mediaContent}
                    ${controls}
                    ${navigation}
                </div>
            `;

            // Handle video playback with full controls - match file manager approach
            if (type === 'video') {
                setTimeout(() => {
                    const video = document.getElementById('mediaViewerVideo');
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    const playIcon = document.getElementById('playIcon');
                    const progressBar = document.getElementById('progressBar');
                    const bufferedBar = document.getElementById('bufferedBar');
                    const progressHandle = document.getElementById('progressHandle');
                    const progressContainer = document.getElementById('progressContainer');
                    const timeDisplay = document.getElementById('timeDisplay');
                    const volumeBtn = document.getElementById('volumeBtn');
                    const volumeIcon = document.getElementById('volumeIcon');

                    if (!video) return;

                    // Format time helper
                    function formatTime(seconds) {
                        if (isNaN(seconds)) return '0:00';
                        const mins = Math.floor(seconds / 60);
                        const secs = Math.floor(seconds % 60);
                        return `${mins}:${secs.toString().padStart(2, '0')}`;
                    }

                    // Load video (no auto-mute)
                    video.preload = 'auto';
                    video.load();

                    // Try to autoplay with sound
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(() => {
                            console.log('Autoplay prevented - user must click play');
                        });
                    }

                    // Play/Pause button
                    if (playPauseBtn) {
                        playPauseBtn.onclick = () => {
                            if (video.paused) {
                                video.play();
                            } else {
                                video.pause();
                            }
                        };
                    }

                    // Click on video to play/pause
                    video.onclick = () => {
                        if (video.paused) {
                            video.play();
                        } else {
                            video.pause();
                        }
                    };

                    // Update play icon on state change
                    video.onplay = () => {
                        if (playIcon) playIcon.className = 'bi bi-pause-fill text-2xl';
                    };

                    video.onpause = () => {
                        if (playIcon) playIcon.className = 'bi bi-play-fill text-2xl';
                    };

                    // Progress bar update
                    video.ontimeupdate = () => {
                        const progress = (video.currentTime / video.duration) * 100;
                        if (progressBar) progressBar.style.width = progress + '%';
                        if (progressHandle) progressHandle.style.left = progress + '%';
                        if (timeDisplay) timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                    };

                    // Buffered progress
                    video.onprogress = () => {
                        if (video.buffered.length > 0 && bufferedBar) {
                            const buffered = (video.buffered.end(video.buffered.length - 1) / video.duration) * 100;
                            bufferedBar.style.width = buffered + '%';
                        }
                    };

                    // Click on progress bar to seek
                    if (progressContainer) {
                        progressContainer.onclick = (e) => {
                            const rect = progressContainer.getBoundingClientRect();
                            const percent = (e.clientX - rect.left) / rect.width;
                            video.currentTime = percent * video.duration;
                        };
                    }

                    // Volume toggle
                    if (volumeBtn) {
                        volumeBtn.onclick = () => {
                            video.muted = !video.muted;
                            if (volumeIcon) {
                                volumeIcon.className = video.muted ? 'bi bi-volume-mute-fill text-xl' : 'bi bi-volume-up-fill text-xl';
                            }
                        };
                    }

                    // Skip function
                    window.skipMediaVideo = (seconds) => {
                        video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
                    };
                }, 100);
            }

            // Define control functions in modal scope
            if (type === 'image') {
                window.rotateMedia = (deg) => {
                    rotation += deg;
                    const img = document.getElementById('mediaViewerImage');
                    if (img) img.style.transform = `rotate(${rotation}deg) scale(${scale})`;
                };

                window.zoomMedia = (delta) => {
                    scale = Math.max(minScale, Math.min(maxScale, scale + delta));
                    const img = document.getElementById('mediaViewerImage');
                    if (img) img.style.transform = `rotate(${rotation}deg) scale(${scale})`;
                };

                window.resetMedia = () => {
                    rotation = 0;
                    scale = 1;
                    const img = document.getElementById('mediaViewerImage');
                    if (img) img.style.transform = 'rotate(0deg) scale(1)';
                };

                // Add pinch-to-zoom support for mobile
                const img = document.getElementById('mediaViewerImage');
                if (img) {
                    let initialDistance = 0;
                    let initialScale = 1;

                    img.addEventListener('touchstart', (e) => {
                        if (e.touches.length === 2) {
                            e.preventDefault();
                            initialDistance = getDistance(e.touches[0], e.touches[1]);
                            initialScale = scale;
                        }
                    }, { passive: false });

                    img.addEventListener('touchmove', (e) => {
                        if (e.touches.length === 2) {
                            e.preventDefault();
                            const currentDistance = getDistance(e.touches[0], e.touches[1]);
                            const scaleChange = currentDistance / initialDistance;
                            scale = Math.max(minScale, Math.min(maxScale, initialScale * scaleChange));
                            img.style.transform = `rotate(${rotation}deg) scale(${scale})`;
                        }
                    }, { passive: false });

                    function getDistance(touch1, touch2) {
                        const dx = touch1.clientX - touch2.clientX;
                        const dy = touch1.clientY - touch2.clientY;
                        return Math.sqrt(dx * dx + dy * dy);
                    }
                }
            }
        }

        function navigateMedia(direction) {
            const newIndex = currentMediaIndex + direction;
            if (newIndex >= 0 && newIndex < currentMediaArray.length) {
                currentMediaIndex = newIndex;
                const modal = document.getElementById('mediaViewerModal');
                if (modal) {
                    // Pause current video if any
                    const video = document.getElementById('mediaViewerVideo');
                    if (video) video.pause();

                    renderMediaViewer(modal);
                }
            }
        }

        function viewAllMedia() {
            if (!selectedGatePass) return;

            // Prevent body scroll on mobile
            document.body.style.overflow = 'hidden';

            // Open modal with all media in a grid
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center p-4';
            modal.style.zIndex = '200';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    document.body.style.overflow = '';
                }
            };

            const closeBtn = `
                <button onclick="this.parentElement.remove(); document.body.style.overflow = '';"
                        class="absolute top-2 md:top-4 right-2 md:right-4 text-white bg-red-500 hover:bg-red-600 active:bg-red-700 rounded-full w-14 h-14 md:w-12 md:h-12 flex items-center justify-center text-3xl md:text-2xl z-10 shadow-lg touch-manipulation transition-all">
                    &times;
                </button>
            `;

            modal.innerHTML = closeBtn + `
                <div class="bg-white rounded-xl max-w-7xl w-full max-h-[90vh] overflow-y-auto p-4 md:p-8 shadow-2xl" onclick="event.stopPropagation()">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 md:mb-6 gap-3">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Media Gallery</h2>
                            <p class="text-sm md:text-base text-gray-600 mt-1">Thock Number: <span class="font-semibold">${selectedGatePass.thock_number}</span></p>
                        </div>
                        <div id="allMediaStats" class="text-left md:text-right">
                            <div class="text-sm text-gray-500">Loading...</div>
                        </div>
                    </div>
                    <div id="allMediaContent">
                        <div class="flex items-center justify-center py-12">
                            <div class="text-gray-400">Loading media...</div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Load all media
            loadAllMediaInModal(selectedGatePass.thock_number);
        }

        async function loadAllMediaInModal(thockNumber) {
            try {
                // Reuse cached media data if available for the same thock
                let entryMedia, pickupMedia, editMedia;
                if (window.cachedMediaThock === thockNumber && window.cachedMediaData) {
                    entryMedia = window.cachedMediaData.entry_media || [];
                    pickupMedia = window.cachedMediaData.pickup_media || [];
                    editMedia = window.cachedMediaData.edit_media || [];
                } else {
                    const [gpResponse, reResponse] = await Promise.all([
                        fetch(`/api/gate-passes/media/by-thock?thock_number=${encodeURIComponent(thockNumber)}`,
                            { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`/api/room-entries/media/by-thock?thock_number=${encodeURIComponent(thockNumber)}`,
                            { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);

                    if (!gpResponse.ok) throw new Error('Failed to load media');

                    const gpData = await gpResponse.json();
                    entryMedia = gpData.entry_media || [];
                    pickupMedia = gpData.pickup_media || [];
                    editMedia = [];
                    if (reResponse.ok) {
                        const reData = await reResponse.json();
                        editMedia = reData.edit_media || [];
                    }
                    // Cache for reuse
                    window.cachedMediaThock = thockNumber;
                    window.cachedMediaData = { ...gpData, edit_media: editMedia };
                }
                const totalMedia = entryMedia.length + pickupMedia.length + editMedia.length;

                // Helper function to format timestamp
                const formatTimestamp = (timestamp) => {
                    if (!timestamp) return 'Unknown time';
                    const date = new Date(timestamp);
                    return date.toLocaleString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                // Helper function to format file size
                const formatFileSize = (bytes) => {
                    if (!bytes) return '';
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                };

                // Update stats
                const statsDiv = document.getElementById('allMediaStats');
                statsDiv.innerHTML = `
                    <div class="text-2xl font-bold text-gray-800">${totalMedia}</div>
                    <div class="text-sm text-gray-500">Total Files</div>
                    <div class="flex flex-wrap gap-4 mt-2 text-sm">
                        <div class="flex items-center gap-1">
                            <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                            <span>${entryMedia.length} Entry</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span>${pickupMedia.length} Pickup</span>
                        </div>
                        ${editMedia.length > 0 ? `
                        <div class="flex items-center gap-1">
                            <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                            <span>${editMedia.length} Edit</span>
                        </div>
                        ` : ''}
                    </div>
                `;

                const contentDiv = document.getElementById('allMediaContent');

                if (totalMedia === 0) {
                    contentDiv.innerHTML = '<p class="text-gray-500 text-center py-12">No media available</p>';
                    return;
                }

                // Combine all media for navigation
                const allMedia = [...entryMedia, ...pickupMedia, ...editMedia];
                window.currentModalMedia = allMedia;

                // Function to render media grid
                const renderMediaGrid = (mediaList, title, colorClass, startIndex) => {
                    if (mediaList.length === 0) return '';

                    return `
                        <div class="mb-8">
                            <div class="flex items-center gap-2 mb-4">
                                <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                                <span class="bg-${colorClass}-100 text-${colorClass}-700 px-3 py-1 rounded-full text-sm font-semibold">
                                    ${mediaList.length} ${mediaList.length === 1 ? 'file' : 'files'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                ${mediaList.map((m, idx) => `
                                    <div class="border-2 border-gray-200 rounded-xl overflow-hidden hover:shadow-xl hover:border-${colorClass}-400 transition-all group">
                                        <div class="relative cursor-pointer"
                                             onclick='openMediaViewer("${m.download_url}", "${m.file_type}", window.currentModalMedia, ${startIndex + idx})'>
                                            ${m.file_type === 'image' ? `
                                                <div class="w-full h-48 bg-black flex items-center justify-center overflow-hidden">
                                                    <img src="${m.download_url}"
                                                         loading="lazy"
                                                         class="max-w-full max-h-full object-contain"
                                                         alt="${m.file_name}">
                                                </div>
                                            ` : `
                                                <div class="w-full h-48 bg-gray-900 overflow-hidden relative flex items-center justify-center">
                                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                                        <i class="bi bi-play-circle-fill text-white text-6xl drop-shadow-lg"></i>
                                                        <span class="text-white text-sm mt-2 drop-shadow">Click to Play</span>
                                                    </div>
                                                </div>
                                            `}

                                            <!-- File Type Badge -->
                                            <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded-md flex items-center gap-1">
                                                <i class="bi bi-${m.file_type === 'image' ? 'image' : 'camera-video'}-fill"></i>
                                                <span class="uppercase">${m.file_type}</span>
                                            </div>

                                            <!-- Media Type Badge -->
                                            <div class="absolute top-2 right-2 bg-${colorClass}-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg">
                                                ${title.toUpperCase()}
                                            </div>

                                            <!-- Hover Overlay -->
                                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                                                <i class="bi bi-zoom-in text-white text-4xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                            </div>
                                        </div>

                                        <!-- Media Info -->
                                        <div class="p-3 bg-gray-50">
                                            <div class="flex items-start gap-2 mb-2">
                                                <i class="bi bi-person-fill text-gray-600 mt-0.5"></i>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-semibold text-gray-800 truncate" title="${m.uploaded_by_user_name || 'Unknown'}">
                                                        ${m.uploaded_by_user_name || 'Unknown User'}
                                                    </p>
                                                </div>
                                            </div>

                                            <div class="flex items-start gap-2 mb-2">
                                                <i class="bi bi-clock text-gray-600 mt-0.5"></i>
                                                <p class="text-xs text-gray-600">
                                                    ${formatTimestamp(m.created_at)}
                                                </p>
                                            </div>

                                            ${m.file_size ? `
                                                <div class="flex items-center gap-2">
                                                    <i class="bi bi-file-earmark text-gray-600"></i>
                                                    <p class="text-xs text-gray-600">
                                                        ${formatFileSize(m.file_size)}
                                                    </p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                };

                // Render all sections with correct indices
                contentDiv.innerHTML =
                    renderMediaGrid(entryMedia, 'Entry Media', 'blue', 0) +
                    renderMediaGrid(pickupMedia, 'Pickup Media', 'green', entryMedia.length) +
                    renderMediaGrid(editMedia, 'Edit Media', 'orange', entryMedia.length + pickupMedia.length);

            } catch (error) {
                console.error('Error loading all media:', error);
                const contentDiv = document.getElementById('allMediaContent');
                if (contentDiv) {
                    contentDiv.innerHTML = '<p class="text-red-500 text-center py-12">Failed to load media. Please try again.</p>';
                }
            }
        }

        function clearSelection() {
            selectedGatePass = null;
            pickupRoomEntries = [];

            // Remove selection
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.classList.remove('selected-ticket');
            });

            // Hide approval form
            document.getElementById('noSelection').classList.remove('hidden');
            document.getElementById('approvalForm').classList.add('hidden');

            // Reset form
            document.getElementById('approvalForm').reset();

            // Reset new fields
            document.getElementById('selectedPhone').textContent = '-';
            document.getElementById('selectedCustomerName').textContent = '-';
            document.getElementById('selectedVillage').textContent = '-';
            document.getElementById('selectedRooms').textContent = '-';
            document.getElementById('selectedFloors').textContent = '-';
            document.getElementById('selectedGatars').textContent = '-';
            document.getElementById('selectedRemark').textContent = '-';
            document.getElementById('selectedQtyBreakdown').textContent = '-';

            // Hide pickup history
            document.getElementById('pickupHistorySection').style.display = 'none';

            // Reset location boxes
            document.querySelectorAll('.location-box').forEach(box => {
                box.classList.remove('bg-red-500', 'text-white');
                box.classList.add('bg-gray-100', 'text-gray-400');
            });
            const gatarElement = document.getElementById('selectedGatar');
            gatarElement.textContent = '-';
            gatarElement.classList.remove('bg-red-500', 'text-white');
            gatarElement.classList.add('bg-gray-100', 'text-gray-700');

            // Reset pickup gatar selection
            selectedPickupGatars = {};
            document.getElementById('pickupGatarList').innerHTML = '';
            document.getElementById('pickupSelectionSummary').innerHTML = '<p class="text-gray-500 text-sm">Select a gate pass first</p>';
            document.getElementById('selectedGatarCount').textContent = '0 items';
            document.getElementById('gateNo').value = '';
        }

        async function approveGatePass(event) {
            event.preventDefault();

            // Validate gatar selection (only for approvals, not rejections)
            const status = document.getElementById('status').value;
            if (status === 'approved') {
                const selectedCount = Object.keys(selectedPickupGatars).length;
                if (selectedCount === 0) {
                    alert(i18n.t('select_gatar_first', 'Please select at least one pickup gatar location!'));
                    return;
                }

                // Calculate total selected quantity
                const approvedQty = parseInt(document.getElementById('approvedQuantity').value);
                let selectedQty = 0;
                Object.values(selectedPickupGatars).forEach(qty => {
                    selectedQty += qty;
                });

                if (selectedQty === 0) {
                    alert(i18n.t('enter_qty_gatar', 'Please enter quantity for at least one gatar!'));
                    return;
                }

                if (approvedQty > selectedQty) {
                    alert(i18n.t('approved_exceeds_selected', `Approved quantity (${approvedQty}) exceeds selected gatar quantity (${selectedQty} items). Please increase gatar quantities or reduce approved quantity.`));
                    return;
                }
            }

            const gatePassId = parseInt(document.getElementById('gatePassId').value);
            const approvalData = {
                approved_quantity: parseInt(document.getElementById('approvedQuantity').value),
                gate_no: document.getElementById('gateNo').value.trim(),
                status: status,
                remarks: document.getElementById('approvalRemarks').value.trim()
            };

            try {
                const response = await fetch(`/api/gate-passes/${gatePassId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(approvalData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('gate_pass_approved', 'Gate pass approved successfully!'));
                clearSelection();
                loadPendingGatePasses();
                loadApprovedPasses();

            } catch (error) {
                alert(i18n.t('error_approving', 'Error approving gate pass') + ': ' + error.message);
            }
        }

        async function loadApprovedPasses() {
            try {
                const response = await fetch('/api/gate-passes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const allPasses = await response.json();
                const approvedPasses = allPasses.filter(gp => gp.status === 'approved');

                displayApprovedPasses(approvedPasses.slice(0, 10));

            } catch (error) {
                console.error('Error loading approved passes:', error);
            }
        }

        function displayApprovedPasses(passes) {
            const tbody = document.getElementById('approvedTableBody');

            // Include both approved and partially_completed gate passes
            const activePasses = passes.filter(gp =>
                gp.status === 'approved' || gp.status === 'partially_completed'
            );

            if (activePasses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">${i18n.t('no_approved_waiting', 'No approved passes waiting for pickup')}</td></tr>`;
                return;
            }

            tbody.innerHTML = activePasses.map(gp => {
                const approvedQty = gp.approved_quantity || gp.requested_quantity;
                const pickedUp = gp.total_picked_up || 0;
                const remaining = approvedQty - pickedUp;

                // Get recipient name
                const recipient = getRecipient(gp);

                // Progress bar color
                let progressColor = 'bg-orange-500';
                let progressPercent = (pickedUp / approvedQty) * 100;
                if (progressPercent >= 100) progressColor = 'bg-green-500';
                else if (progressPercent >= 50) progressColor = 'bg-yellow-500';

                // Action button - Record Pickup or Complete
                let actionBtn = '';
                if (remaining > 0) {
                    actionBtn = `
                        <button onclick='openPickupModal(${JSON.stringify(gp)})'
                            class="neu-button bg-blue-500 text-white text-xs px-2 py-1">
                            <i class="bi bi-box-arrow-up"></i> Pickup
                        </button>
                    `;
                } else {
                    actionBtn = `
                        <button onclick="completeGatePass(${gp.id})"
                            class="neu-button bg-green-500 text-white text-xs px-2 py-1">
                            <i class="bi bi-check-circle"></i> Complete
                        </button>
                    `;
                }

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2" style="${getThockColor(gp.thock_number)}">${gp.thock_number}</td>
                        <td class="p-2 text-sm text-purple-600 font-semibold truncate max-w-[100px]" title="${recipient}">${recipient}</td>
                        <td class="p-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${remaining === 0 ? 'text-green-600' : 'text-orange-600'}">${pickedUp}/${approvedQty}</span>
                                <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="${progressColor} h-full" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="p-2">${actionBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        let currentPickupGatePass = null;

        async function openPickupModal(gatePass) {
            currentPickupGatePass = gatePass;
            const approvedQty = gatePass.approved_quantity || gatePass.requested_quantity;
            const pickedUp = gatePass.total_picked_up || 0;
            const remaining = approvedQty - pickedUp;

            // Extract recipient from remarks
            let recipient = '-';
            if (gatePass.remarks) {
                const match = gatePass.remarks.match(/Recipient:\s*([^|]+)/i);
                if (match) recipient = match[1].trim();
            }

            document.getElementById('pickupGatePassId').value = gatePass.id;
            document.getElementById('pickupThockNumber').textContent = gatePass.thock_number;
            document.getElementById('pickupRecipient').textContent = recipient;
            document.getElementById('pickupApprovedQty').textContent = approvedQty + ' items';
            document.getElementById('pickupAlreadyPickedUp').textContent = pickedUp + ' items';
            document.getElementById('pickupRemaining').textContent = remaining + ' items';
            document.getElementById('pickupQuantity').value = remaining;
            document.getElementById('pickupQuantity').max = remaining;
            document.getElementById('pickupRemarks').value = '';

            // Fetch storage location from room_entries
            document.getElementById('storageLocationInfo').innerHTML = '<span class="text-gray-500">Loading...</span>';
            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const roomEntries = await response.json();
                    const thockEntries = roomEntries.filter(re => re.thock_number === gatePass.thock_number);

                    if (thockEntries.length > 0) {
                        const locationHtml = thockEntries.map(re => `
                            <div class="inline-block m-1 p-2 bg-white neu-border text-sm">
                                <span class="font-bold text-blue-600">Room ${re.room_no}</span> |
                                <span class="font-bold text-green-600">Floor ${re.floor}</span> |
                                <span class="font-bold text-purple-600">Gate ${re.gate_no}</span> |
                                <span class="font-bold">${re.quantity} items</span>
                            </div>
                        `).join('');
                        document.getElementById('storageLocationInfo').innerHTML = locationHtml;

                        // Pre-fill room and floor from first entry
                        document.getElementById('pickupRoomNo').value = thockEntries[0].room_no || '';
                        document.getElementById('pickupFloor').value = thockEntries[0].floor || '';
                    } else {
                        document.getElementById('storageLocationInfo').innerHTML = '<span class="text-red-500">No storage location found</span>';
                        document.getElementById('pickupRoomNo').value = '';
                        document.getElementById('pickupFloor').value = '';
                    }
                }
            } catch (error) {
                console.error('Error fetching storage location:', error);
                document.getElementById('storageLocationInfo').innerHTML = '<span class="text-red-500">Failed to load</span>';
            }

            document.getElementById('pickupModal').classList.remove('hidden');
        }

        function previewPickupMedia(input) {
            const previewDiv = document.getElementById('pickupMediaPreview');
            const thumbnailsDiv = document.getElementById('pickupMediaThumbnails');
            const countSpan = document.getElementById('pickupMediaCount');

            if (!input.files || input.files.length === 0) {
                previewDiv.classList.add('hidden');
                return;
            }

            countSpan.textContent = input.files.length;
            previewDiv.classList.remove('hidden');

            // Clear previous thumbnails
            thumbnailsDiv.innerHTML = '';

            // Generate thumbnails for each file
            Array.from(input.files).forEach((file, index) => {
                const isVideo = file.type.startsWith('video/');
                const isImage = file.type.startsWith('image/');

                const thumbDiv = document.createElement('div');
                thumbDiv.className = 'relative border-2 border-green-300 rounded-lg overflow-hidden h-16';

                if (isImage) {
                    const objUrl = URL.createObjectURL(file);
                    thumbDiv.innerHTML = `
                        <img src="${objUrl}" class="w-full h-full object-cover" onload="URL.revokeObjectURL(this.src)">
                        <div class="absolute top-0 right-0 bg-green-500 text-white text-[8px] px-1 rounded-bl">
                            ${index + 1}
                        </div>
                    `;
                } else if (isVideo) {
                    thumbDiv.innerHTML = `
                        <div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 flex flex-col items-center justify-center">
                            <i class="bi bi-play-circle-fill text-white text-xl"></i>
                            <span class="text-white text-[8px] mt-0.5">VIDEO</span>
                        </div>
                        <div class="absolute top-0 right-0 bg-green-500 text-white text-[8px] px-1 rounded-bl">
                            ${index + 1}
                        </div>
                    `;
                } else {
                    thumbDiv.innerHTML = `
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                            <i class="bi bi-file-earmark text-gray-500"></i>
                        </div>
                    `;
                }

                thumbnailsDiv.appendChild(thumbDiv);
            });
        }

        // Handler for camera capture (merges photo/video captures into main file input)
        function handlePickupMediaCapture(input) {
            const mainInput = document.getElementById('pickupMediaFiles');

            if (input.files && input.files.length > 0) {
                // Create a new FileList-like object by combining existing and new files
                const dt = new DataTransfer();

                // Add existing files from main input
                if (mainInput.files) {
                    Array.from(mainInput.files).forEach(file => dt.items.add(file));
                }

                // Add new captured files
                Array.from(input.files).forEach(file => dt.items.add(file));

                // Update main input with combined files
                mainInput.files = dt.files;

                // Trigger preview update
                previewPickupMedia(mainInput);

                // Reset the capture input
                input.value = '';
            }
        }

        function closePickupModal() {
            document.getElementById('pickupModal').classList.add('hidden');
            currentPickupGatePass = null;

            // Reset file inputs and progress bar
            const fileInput = document.getElementById('pickupMediaFiles');
            if (fileInput) fileInput.value = '';
            const photoInput = document.getElementById('pickupPhotoInput');
            if (photoInput) photoInput.value = '';
            const videoInput = document.getElementById('pickupVideoInput');
            if (videoInput) videoInput.value = '';

            // Hide preview
            const previewDiv = document.getElementById('pickupMediaPreview');
            if (previewDiv) previewDiv.classList.add('hidden');

            const progressDiv = document.getElementById('pickupUploadProgress');
            if (progressDiv) {
                progressDiv.classList.add('hidden');
                document.getElementById('pickupUploadBar').style.width = '0%';
                document.getElementById('pickupUploadPercent').textContent = '0%';
                document.getElementById('pickupUploadStatus').textContent = 'Uploading...';
                document.getElementById('pickupUploadStatus').classList.remove('text-red-700');
            }
        }

        async function submitPickup(event) {
            event.preventDefault();

            const gatePassId = parseInt(document.getElementById('pickupGatePassId').value);

            // Build gatar breakdown array from selected gatars
            const gatarBreakdown = [];
            Object.keys(selectedPickupGatars).forEach(idx => {
                const qty = selectedPickupGatars[idx];
                if (qty > 0) {
                    const cell = document.getElementById(`gatar-cell-${idx}`);
                    if (cell) {
                        const gatarNo = parseInt(cell.dataset.gate);
                        if (!isNaN(gatarNo) && gatarNo > 0) {
                            gatarBreakdown.push({
                                gatar_no: gatarNo,
                                quantity: qty
                            });
                        }
                    }
                }
            });

            const pickupData = {
                gate_pass_id: gatePassId,
                pickup_quantity: parseInt(document.getElementById('pickupQuantity').value),
                room_no: document.getElementById('pickupRoomNo').value,
                floor: document.getElementById('pickupFloor').value,
                remarks: document.getElementById('pickupRemarks').value,
                gatar_breakdown: gatarBreakdown.length > 0 ? gatarBreakdown : undefined
            };

            try {
                const response = await fetch('/api/gate-passes/pickup', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pickupData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const result = await response.json();
                const pickupId = result.pickup_id;

                // Upload media if files selected
                let uploadedMediaCount = 0;
                const fileInput = document.getElementById('pickupMediaFiles');
                if (fileInput && fileInput.files.length > 0) {
                    uploadedMediaCount = fileInput.files.length;
                    await uploadPickupMedia(fileInput.files, currentPickupGatePass, pickupId);
                }

                // Show success message with media count
                const successMsg = uploadedMediaCount > 0
                    ? i18n.t('pickup_recorded', 'Pickup recorded successfully! Inventory updated.') +
                      ` ${uploadedMediaCount} media ${uploadedMediaCount === 1 ? 'file' : 'files'} uploaded.`
                    : i18n.t('pickup_recorded', 'Pickup recorded successfully! Inventory updated.');
                alert(successMsg);

                closePickupModal();
                loadApprovedPasses();

                // If this was the currently selected gate pass, refresh its media
                if (selectedGatePass && selectedGatePass.id === currentPickupGatePass.id && uploadedMediaCount > 0) {
                    // Wait a moment for backend to process, then reload media
                    setTimeout(() => {
                        loadMediaForGatePass(selectedGatePass.thock_number, selectedGatePass.id);
                    }, 500);
                }

            } catch (error) {
                alert(i18n.t('error_recording_pickup', 'Error recording pickup') + ': ' + error.message);
            }
        }

        async function uploadPickupMedia(files, gatePass, pickupId) {
            const progressDiv = document.getElementById('pickupUploadProgress');
            const progressBar = document.getElementById('pickupUploadBar');
            const statusText = document.getElementById('pickupUploadStatus');
            const percentText = document.getElementById('pickupUploadPercent');

            progressDiv.classList.remove('hidden');
            statusText.textContent = 'Uploading...';
            statusText.className = 'text-xs font-bold text-green-700';

            const thockNo = gatePass.thock_number;
            const customerName = gatePass.customer_name;
            const userInfo = getUserInfoFromToken();

            const safeCustomer = customerName.replace(/[^a-zA-Z0-9 \u0900-\u097F]/g, '').trim().replace(/\s+/g, '_');
            const safeEmployee = userInfo.name.replace(/[^a-zA-Z0-9 \u0900-\u097F]/g, '').trim().replace(/\s+/g, '_');
            const safeThok = thockNo.toString().replace(/\//g, '-').replace(/[^a-zA-Z0-9\-]/g, '');

            const targetPath = 'Room Config';

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const extension = file.name.includes('.') ? file.name.split('.').pop() : 'jpg';
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const newFileName = `Thok_${safeThok}_${safeCustomer}_pickup_GP${gatePass.id}_By_${safeEmployee}_ID${userInfo.id}_${timestamp}.${extension}`;

                statusText.textContent = `Uploading file ${i + 1} of ${files.length}...`;

                // Step 1: Upload file
                try {
                    await uploadSingleFile(file, targetPath, (pct) => {
                        const totalPct = ((i + (pct/100)) / files.length) * 100;
                        progressBar.style.width = `${totalPct}%`;
                        percentText.textContent = `${Math.round(totalPct)}%`;
                    }, newFileName);
                } catch (uploadErr) {
                    console.error(`File upload failed for ${newFileName}:`, uploadErr);
                    failCount++;
                    statusText.textContent = `File ${i + 1} upload failed - skipping`;
                    statusText.className = 'text-xs font-bold text-red-700';
                    continue; // Skip metadata save ‚Äî file didn't upload
                }

                // Step 2: Save metadata (only if file upload succeeded)
                try {
                    await saveMediaMetadata({
                        gate_pass_id: gatePass.id,
                        gate_pass_pickup_id: pickupId,
                        thock_number: thockNo,
                        media_type: 'pickup',
                        file_name: newFileName,
                        file_path: `Room Config/${newFileName}`,
                        file_type: file.type.startsWith('image/') ? 'image' : 'video',
                        file_size: file.size
                    });
                    successCount++;
                } catch (metaErr) {
                    console.error(`Metadata save failed for ${newFileName}:`, metaErr);
                    failCount++;
                    statusText.textContent = `File ${i + 1} metadata save failed`;
                    statusText.className = 'text-xs font-bold text-red-700';
                }
            }

            if (failCount === 0) {
                statusText.textContent = `Upload Complete (${successCount} files)`;
                statusText.className = 'text-xs font-bold text-green-700';
            } else if (successCount > 0) {
                statusText.textContent = `${successCount} uploaded, ${failCount} failed`;
                statusText.className = 'text-xs font-bold text-orange-600';
            } else {
                statusText.textContent = `Upload Failed (${failCount} files)`;
                statusText.className = 'text-xs font-bold text-red-700';
            }

            setTimeout(() => {
                progressDiv.classList.add('hidden');
                progressBar.style.width = '0%';
            }, 3000);
        }

        // Upload a single file with progress tracking
        function uploadSingleFile(file, path, onProgress, customName = null) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', customName ? new File([file], customName, {type: file.type}) : file);
                formData.append('root', 'bulk');
                formData.append('path', path);

                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        onProgress(Math.round((e.loaded / e.total) * 100));
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve();
                    } else {
                        reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}`));
                    }
                });

                xhr.addEventListener('error', () => reject(new Error('Network Error')));
                xhr.addEventListener('timeout', () => reject(new Error('Upload timed out')));

                xhr.open('POST', '/api/files/upload');
                xhr.timeout = 120000; // 2 minute timeout for large videos
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
            });
        }

        // Save media metadata to database
        async function saveMediaMetadata(mediaData) {
            const resp = await fetch('/api/gate-passes/media', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(mediaData)
            });
            if (!resp.ok) {
                const errText = await resp.text();
                throw new Error(`Metadata save failed (${resp.status}): ${errText}`);
            }
            return await resp.json();
        }

        // Get user name from JWT token
        // Get user info (name and ID) from JWT token
        function getUserInfoFromToken() {
            try {
                const token = localStorage.getItem('token');
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                const data = JSON.parse(jsonPayload);
                return {
                    name: data.name || 'Employee',
                    id: data.user_id || 0
                };
            } catch (e) {
                return { name: 'Employee', id: 0 };
            }
        }

        // Backward compatibility - get just the name
        function getUserNameFromToken() {
            return getUserInfoFromToken().name;
        }

        async function completeGatePass(gatePassId) {
            if (!confirm(i18n.t('confirm_complete', 'Mark this gate pass as completed? All items have been picked up.'))) {
                return;
            }

            try {
                const response = await fetch(`/api/gate-passes/${gatePassId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('gate_pass_completed', 'Gate pass completed successfully!'));
                loadApprovedPasses();

            } catch (error) {
                alert(i18n.t('error_completing', 'Error completing gate pass') + ': ' + error.message);
            }
        }

        function goBack() {
            window.history.back();
        }

        // Load recent gate passes (recently created/entered requests)
        async function loadRecentGatePasses() {
            try {
                const response = await fetch('/api/gate-passes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load gate passes');
                }

                const allPasses = await response.json();

                // Sort by issued_at (creation date) descending and take last 20
                const recentPasses = allPasses
                    .sort((a, b) => new Date(b.issued_at) - new Date(a.issued_at))
                    .slice(0, 20);

                displayRecentPasses(recentPasses);
                updateStats(allPasses);

            } catch (error) {
                console.error('Error loading recent gate passes:', error);
                document.getElementById('recentTableBody').innerHTML =
                    `<tr><td colspan="5" class="text-center p-4 text-red-500">${i18n.t('failed_load', 'Failed to load')}</td></tr>`;
            }
        }

        function displayRecentPasses(passes) {
            const tbody = document.getElementById('recentTableBody');

            if (passes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">${i18n.t('no_recent_passes', 'No recent passes')}</td></tr>`;
                return;
            }

            tbody.innerHTML = passes.map(gp => {
                // Status badge based on all possible statuses
                let statusClass = 'bg-gray-100 text-gray-600';
                let statusText = gp.status;

                if (gp.status === 'pending') {
                    statusClass = 'bg-yellow-100 text-yellow-700';
                    statusText = i18n.t('pending', 'Pending');
                } else if (gp.status === 'approved') {
                    statusClass = 'bg-blue-100 text-blue-700';
                    statusText = i18n.t('approved', 'Approved');
                } else if (gp.status === 'partially_completed') {
                    statusClass = 'bg-purple-100 text-purple-700';
                    statusText = i18n.t('partial', 'Partial');
                } else if (gp.status === 'completed') {
                    statusClass = 'bg-green-100 text-green-700';
                    statusText = i18n.t('completed', 'Completed');
                } else if (gp.status === 'rejected') {
                    statusClass = 'bg-red-100 text-red-700';
                    statusText = i18n.t('rejected', 'Rejected');
                } else if (gp.status === 'expired') {
                    statusClass = 'bg-orange-100 text-orange-700';
                    statusText = i18n.t('expired', 'Expired');
                }

                // Get recipient name
                const recipient = getRecipient(gp);

                // Format date - show when it was created (issued_at)
                const formattedDate = gp.issued_at ? new Date(gp.issued_at).toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2" style="${getThockColor(gp.thock_number)}">${gp.thock_number}</td>
                        <td class="p-2 text-sm truncate max-w-[100px]" title="${gp.customer_name}">${gp.customer_name}</td>
                        <td class="p-2 text-sm truncate max-w-[100px] text-purple-600 font-semibold" title="${recipient}">${recipient}</td>
                        <td class="p-2 font-bold">${gp.requested_quantity}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${statusText}</span>
                        </td>
                        <td class="p-2 text-xs text-gray-600">${formattedDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats(allPasses) {
            const pending = allPasses.filter(gp => gp.status === 'pending').length;
            const approved = allPasses.filter(gp => gp.status === 'approved' || gp.status === 'partially_completed').length;

            // Count completed today
            const today = new Date().toDateString();
            const completedToday = allPasses.filter(gp => {
                if (gp.status !== 'completed') return false;
                const completedDate = gp.completed_at ? new Date(gp.completed_at).toDateString() : null;
                return completedDate === today;
            }).length;

            document.getElementById('statPending').textContent = pending;
            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statCompleted').textContent = completedToday;
        }

        // Load on page load
        window.addEventListener('load', function() {
            loadPendingGatePasses();
            loadApprovedPasses();
            loadRecentGatePasses();

            // Auto-refresh every 10 seconds
            setInterval(() => {
                loadPendingGatePasses();
                loadApprovedPasses();
                loadRecentGatePasses();
            }, 10000);
        });

    </script>

</body>
</html>
