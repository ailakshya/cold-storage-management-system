name: Deploy to K3s (GitHub-Hosted)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.5.40) - leave empty for auto"
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      version: ${{ steps.version.outputs.version }}
      image: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Generate version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION=$(echo "${{ inputs.version }}" | xargs)
          else
            VERSION="v1.5.${{ github.run_number }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "=== Building version: ${VERSION} ==="

      - name: Build Go binary
        run: |
          export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-w -s" -o server ./cmd/server
          echo "✓ Go binary built"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.ci
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Setup kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Update deployments
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"

          kubectl set image deployment/cold-backend-employee \
            cold-backend=${IMAGE} -n default
          kubectl set image deployment/cold-backend-customer \
            cold-backend=${IMAGE} -n default

          echo "=== Triggered rollout: ${VERSION} ==="

      - name: Wait for rollout
        run: |
          echo "=== Waiting for deployments (up to 3 min each) ==="

          if ! kubectl rollout status deployment/cold-backend-employee -n default --timeout=180s; then
            echo "⚠ Employee rollout timeout - checking status"
          fi

          if ! kubectl rollout status deployment/cold-backend-customer -n default --timeout=180s; then
            echo "⚠ Customer rollout timeout - checking status"
          fi

      - name: Health check
        id: health
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          echo "=== Health Check ==="

          sleep 10

          READY_PODS=$(kubectl get pods -l app=cold-backend -n default \
            -o jsonpath='{range .items[*]}{.spec.containers[0].image}{" "}{.status.containerStatuses[0].ready}{"\n"}{end}' | \
            grep "${VERSION}" | grep -c "true" || echo "0")

          TOTAL_PODS=$(kubectl get pods -l app=cold-backend -n default \
            -o jsonpath='{.items[*].spec.containers[0].image}' | \
            grep -o "${VERSION}" | wc -w || echo "0")

          echo "Ready: ${READY_PODS}/${TOTAL_PODS} pods on ${VERSION}"

          if [ "$READY_PODS" -ge 2 ]; then
            echo "✓ Deployment healthy"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "⚠ Less than 2 pods ready"
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi

          kubectl get pods -l app=cold-backend -n default \
            -o custom-columns="POD:.metadata.name,IMAGE:.spec.containers[0].image,READY:.status.containerStatuses[0].ready" \
            --no-headers

      - name: Rollback on failure
        if: steps.health.outputs.healthy == 'false'
        run: |
          echo "=== Rolling back due to unhealthy deployment ==="
          kubectl rollout undo deployment/cold-backend-employee -n default || true
          kubectl rollout undo deployment/cold-backend-customer -n default || true
          echo "✓ Rollback initiated"
          exit 1
