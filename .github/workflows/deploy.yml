name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone is faster

      # Use pre-installed Go if available to save setup time
      # Since we are on self-hosted, we can likely skip setup-go if Go is in path
      # effectively using the system go
      
      - name: Build Application
        run: |
          echo "Building server binary..."
          # Explicitly add Go to PATH
          export PATH=$PATH:/usr/local/go/bin
          
          # Use Go cache in temp to avoid permission issues
          export GOCACHE=/tmp/go-build-cache
          mkdir -p $GOCACHE
          
          # Build binary with optimizations
          # -trimpath removes file system paths from binary for reproducibility
          CGO_ENABLED=0 go build -trimpath -ldflags="-w -s" -o cold-backend ./cmd/server

      - name: Prepare Assets
        run: |
          echo "Preparing static assets..."
          # Ensure static directory exists
          mkdir -p static
          # Copy portfolio template to index.html for the website mode
          cp templates/portfolio.html static/index.html

      - name: Deploy via Remote Build
        env:
          HOST: 192.168.15.131
          USER: cold
          PASS: ${{ secrets.SUDO_PASSWORD }}
        run: |
          echo "Installing sshpass..."
          if ! command -v sshpass &> /dev/null; then
             sudo apt-get update && sudo apt-get install -y sshpass
          fi

          echo "Preparing remote build environment..."
          # Clean previous build temp if exists and recreate
          sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no $USER@$HOST "rm -rf ~/source_temp && mkdir -p ~/source_temp"

          echo "Transferring source code..."
          # Transfer current directory contents to remote temp excluding .git and other non-essentials
          # Using rsync if available would be better, but scp is safer default
          # We transfer everything in current dir (.)
          sshpass -p "$PASS" scp -o StrictHostKeyChecking=no -r . $USER@$HOST:~/source_temp/

          echo "Building and Deploying on Remote Server..."
          sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no $USER@$HOST << EOF
            set -e # Fail on error

            # Setup Go Environment
            export PATH=\$PATH:/usr/local/go/bin
            export GOCACHE=/tmp/go-build-cache
            mkdir -p \$GOCACHE

            cd ~/source_temp

            echo "Building binary locally on server..."
            CGO_ENABLED=0 go build -trimpath -ldflags="-w -s" -o cold-backend ./cmd/server

            echo "Deploying to production..."
            APP_DIR=~/cold-storage
            mkdir -p \$APP_DIR

            # Backup logic
            if [ -f \$APP_DIR/server ]; then
                cp \$APP_DIR/server \$APP_DIR/server.bak
            fi

            # Install new binary
            mv cold-backend \$APP_DIR/server
            chmod +x \$APP_DIR/server

            # Update Assets
            rm -rf \$APP_DIR/static \$APP_DIR/templates
            cp -r static \$APP_DIR/
            cp -r templates \$APP_DIR/

            # Prepare website index
            cp templates/portfolio.html \$APP_DIR/static/index.html

            echo "Cleaning up..."
            cd ~
            rm -rf ~/source_temp

            echo "Restarting services..."
            echo "$PASS" | sudo -S systemctl restart cold-employee cold-customer cold-website
          EOF

          echo "Verifying deployment..."
          sleep 10
          sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no $USER@$HOST "systemctl is-active cold-employee cold-customer cold-website"
