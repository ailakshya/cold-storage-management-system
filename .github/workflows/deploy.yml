name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone is faster

      # Use pre-installed Go if available to save setup time
      # Since we are on self-hosted, we can likely skip setup-go if Go is in path
      # effectively using the system go
      
      - name: Build Application
        run: |
          echo "Building server binary..."
          # Ensure Go is in path
          export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
          
          # Use Go cache if possible
          export GOCACHE=/tmp/go-build-cache
          mkdir -p $GOCACHE
          
          # Build binary with optimizations
          # -trimpath removes file system paths from binary for reproducibility
          CGO_ENABLED=0 go build -trimpath -ldflags="-w -s" -o cold-backend ./cmd/server

      - name: Deploy to Server
        run: |
          APP_DIR=~/cold-storage
          LOG_FILE=$APP_DIR/server.log
          
          echo "Preparing deployment..."
          mkdir -p $APP_DIR
          
          # Backup current binary if exists
          if [ -f $APP_DIR/server ]; then
            echo "Backing up current binary..."
            cp $APP_DIR/server $APP_DIR/server.bak
          fi
          
          # Install new binary
          echo "Installing new binary..."
          mv cold-backend $APP_DIR/server
          chmod +x $APP_DIR/server
          
          # Restart services using systemd
          echo "Restarting services..."
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl restart cold-employee cold-customer
          
          # Wait and check
          echo "Verifying deployment..."
          sleep 5
          
          if systemctl is-active --quiet cold-employee && systemctl is-active --quiet cold-customer; then
            echo "✅ Services started successfully"
            echo "Employee Service Status:"
            systemctl status cold-employee --no-pager
            echo "Customer Service Status:"
            systemctl status cold-customer --no-pager
          else
            echo "❌ Services failed to start"
            journalctl -u cold-employee -n 20 --no-pager
            journalctl -u cold-customer -n 20 --no-pager
            exit 1
          fi
