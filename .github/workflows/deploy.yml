name: Deploy to K3s

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.5.40) - leave empty for auto'
        required: false
        type: string

env:
  IMAGE_NAME: lakshyajaat/cold-backend
  K3S_NODES: "192.168.15.110 192.168.15.111 192.168.15.112 192.168.15.113 192.168.15.114"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION=$(echo "${{ inputs.version }}" | xargs)
          else
            VERSION="v1.5.${{ github.run_number }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "=== Deploying version: ${VERSION} ==="

      - name: Build Go binary
        run: |
          # Use system Go if available, skip setup-go action
          export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o server ./cmd/server
          echo "✓ Go binary built"

      - name: Build Docker image
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Use Docker BuildKit for faster builds with caching
          DOCKER_BUILDKIT=1 docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t ${{ env.IMAGE_NAME }}:${VERSION} .
          echo "✓ Docker image built: ${VERSION}"

      - name: Save and deploy to all nodes (parallel)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAR_FILE="/tmp/cold-backend-${VERSION}.tar"

          # Save image
          docker save ${{ env.IMAGE_NAME }}:${VERSION} -o ${TAR_FILE}
          echo "✓ Image saved ($(du -h ${TAR_FILE} | cut -f1))"

          # Deploy to ALL nodes in PARALLEL
          echo "=== Deploying to all nodes in parallel ==="
          for NODE in ${{ env.K3S_NODES }}; do
            (
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${TAR_FILE} root@${NODE}:/tmp/ && \
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@${NODE} \
                "k3s ctr -n k8s.io images import /tmp/cold-backend-${VERSION}.tar && rm /tmp/cold-backend-${VERSION}.tar" && \
              echo "✓ Node ${NODE}: done"
            ) &
          done

          # Wait for all parallel jobs
          wait
          echo "=== All nodes updated ==="

      - name: Update Kubernetes deployments
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update both deployments in parallel
          kubectl set image deployment/cold-backend-employee cold-backend=${{ env.IMAGE_NAME }}:${VERSION} -n default &
          kubectl set image deployment/cold-backend-customer cold-backend=${{ env.IMAGE_NAME }}:${VERSION} -n default &
          wait

          echo "Waiting for rollout..."
          kubectl rollout status deployment/cold-backend-employee -n default --timeout=120s &
          kubectl rollout status deployment/cold-backend-customer -n default --timeout=120s &
          wait

          echo "=== Deployed: ${VERSION} ==="

      - name: Cleanup
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          rm -f /tmp/cold-backend-${VERSION}.tar || true

      - name: Verify
        run: |
          kubectl get pods -l app=cold-backend -n default -o custom-columns="POD:.metadata.name,IMAGE:.spec.containers[0].image,READY:.status.containerStatuses[0].ready" --no-headers
