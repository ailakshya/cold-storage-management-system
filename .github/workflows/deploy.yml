name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Build Application
        run: |
          echo "Building server binary..."
          # Build binary with optimizations
          CGO_ENABLED=0 go build -ldflags="-w -s" -o cold-backend ./cmd/server

      - name: Deploy to Server
        run: |
          APP_DIR=~/cold-storage
          LOG_FILE=$APP_DIR/server.log
          
          echo "Preparing deployment..."
          mkdir -p $APP_DIR
          
          # Backup current binary if exists
          if [ -f $APP_DIR/server ]; then
            echo "Backing up current binary..."
            cp $APP_DIR/server $APP_DIR/server.bak
          fi
          
          # Stop running server
          echo "Stopping existing server..."
          pkill -f "cold-storage/server" || true
          sleep 2
          
          # Install new binary
          echo "Installing new binary..."
          mv cold-backend $APP_DIR/server
          chmod +x $APP_DIR/server
          
          # Start server
          echo "Starting server..."
          cd $APP_DIR
          nohup ./server --mode employee > $LOG_FILE 2>&1 &
          
          # Wait and check
          echo "Verifying deployment..."
          sleep 5
          if pgrep -f "server --mode employee" > /dev/null; then
            echo "✅ Server started successfully"
            echo "Recent Logs:"
            tail -n 10 $LOG_FILE
          else
            echo "❌ Server failed to start"
            tail -n 20 $LOG_FILE
            exit 1
          fi
