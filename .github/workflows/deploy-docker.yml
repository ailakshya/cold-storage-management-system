name: Deploy Dockerized

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-docker:
    runs-on: [self-hosted, cold-server-runner]
    steps:
      - name: Clean Workspace
        run: |
          echo "Cleaning workspace..."
          rm -rf ./* || true
          rm -rf ./.git || true
          rm -rf ./.github || true
          # Fix 'file already exists' runner error
          echo "Lak992723/" | sudo -S rm -rf /home/cold/actions-runner/_diag/pages/* || true

      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          submodules: false

      - name: Stop Legacy Systemd Services
        run: |
          echo "Stopping legacy binary services to free up ports..."
          echo "Lak992723/" | sudo -S systemctl stop cold-employee cold-customer cold-website || true
          echo "Lak992723/" | sudo -S systemctl disable cold-employee cold-customer cold-website || true
          echo "Legacy services stopped."

      - name: Deploy with Docker Compose
        env:
          # Pass environment variables typically needed
          DB_HOST: "host.docker.internal"
          DB_USER: "postgres"
          DB_NAME: "cold_db"
          # Password normally passed via secrets
        run: |
          echo "Building and starting containers..."
          
          # Pull latest base images
          echo "Lak992723/" | sudo -S docker compose pull
          
          # Build and start
          echo "Lak992723/" | sudo -S docker compose up -d --build --remove-orphans
          
          echo "Pruning unused images..."
          echo "Lak992723/" | sudo -S docker image prune -f

      - name: Verify Deployment
        run: |
          echo "Waiting for services to initialize..."
          sleep 15
          
          if echo "Lak992723/" | sudo -S docker compose ps | grep -q "Up"; then
             echo "✅ Services are running:"
             echo "Lak992723/" | sudo -S docker compose ps
          else
             echo "❌ Services failed to start"
             echo "Lak992723/" | sudo -S docker compose logs
             exit 1
          fi
