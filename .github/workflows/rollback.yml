name: Rollback Production

on:
  workflow_dispatch:

jobs:
  rollback:
    runs-on: self-hosted
    steps:
      - name: Rollback to Backup
        run: |
          APP_DIR=~/cold-storage
          LOG_FILE=$APP_DIR/server.log
          
          if [ ! -f $APP_DIR/server.bak ]; then
            echo "❌ No backup binary found to rollback to!"
            exit 1
          fi
          
          echo "Stopping current server..."
          pkill -f "cold-storage/server" || true
          sleep 2
          
          echo "Restoring backup binary..."
          mv $APP_DIR/server $APP_DIR/server.failed
          mv $APP_DIR/server.bak $APP_DIR/server
          chmod +x $APP_DIR/server
          
          echo "Starting restored server..."
          cd $APP_DIR
          nohup ./server --mode employee > $LOG_FILE 2>&1 &
          
          echo "Verifying rollback..."
          sleep 5
          if pgrep -f "server --mode employee" > /dev/null; then
            echo "✅ Rollback successful - Server running"
            tail -n 10 $LOG_FILE
          else
            echo "❌ Rollback failed - Server not running"
            tail -n 20 $LOG_FILE
            exit 1
          fi
